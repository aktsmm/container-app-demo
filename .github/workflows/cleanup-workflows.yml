name: ðŸ§¹ Cleanup Workflow Runs (Scheduled)

on:
  schedule:
    - cron: "0 */12 * * *" # 12æ™‚é–“ã”ã¨
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - ".github/workflows/cleanup.yml"
      - ".github/workflows/ðŸ§¹*.yml"

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    # æ‰‹å‹•ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å¸¸ã«å®Ÿè¡Œã€push ã®ã¿ main ã«é™å®šï¼ˆã‚¹ã‚­ãƒƒãƒ—é˜²æ­¢ï¼‰
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest

    steps:
      - name: Debug context (for skip investigation)
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"
          echo "workflow=${{ github.workflow }}"
          echo "actor=${{ github.actor }}"
          echo "repository=${{ github.repository }}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select token (prefer PAT if available)
        id: tok
        run: |
          if [ -n "${{ secrets.GH_PAT_ACTIONS_DELETE }}" ]; then
            echo "token=${{ secrets.GH_PAT_ACTIONS_DELETE }}" >> $GITHUB_OUTPUT
            echo "Using PAT: GH_PAT_ACTIONS_DELETE"
          else
            echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
            echo "Using GITHUB_TOKEN (no PAT provided)"
          fi

      - name: Auth gh cli
        env:
          GH_TOKEN: ${{ steps.tok.outputs.token }}
        run: |
          gh auth status || gh auth login --with-token <<< "$GH_TOKEN"

      - name: ðŸ§¹ Cleanup old runs of this workflow (exclude current)
        env:
          GH_TOKEN: ${{ steps.tok.outputs.token }}
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          SELF_NAME="${GITHUB_WORKFLOW}"

          echo "ðŸ” Getting all runs for workflow: $SELF_NAME"
          RUNS=$(gh run list --workflow "$SELF_NAME" --json databaseId,status --limit 1000)
          CURRENT_ID=$(echo "$RUNS" | jq -r '.[] | select(.status=="in_progress" or .status=="queued") | .databaseId' | head -n 1)

          TARGETS=$(echo "$RUNS" | jq -r --arg cur "$CURRENT_ID" '.[] | select(.databaseId != ($cur|tonumber)) | .databaseId')
          if [ -n "$TARGETS" ]; then
            echo "$TARGETS" | while read -r ID; do
              echo "ðŸ§¹ Deleting old Cleanup run ID: $ID"
              gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "âš ï¸ Failed to delete run $ID"
              sleep 0.3
            done
          else
            echo "âœ… No old Cleanup runs to delete."
          fi

      - name: ðŸ§© Clean other workflow runs (keep 7 human + 3 dependabot + 1 failed)
        env:
          GH_TOKEN: ${{ steps.tok.outputs.token }}
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"

          echo "ðŸ” Listing all workflow runs (paginated)..."
          ALL_RUNS=$(gh api repos/$REPO/actions/runs --paginate \
            -q '.workflow_runs[] | {id: .id, name: .name, conclusion: .conclusion, created_at: .created_at, actor: (.actor.login // "unknown")}' \
            | jq -s 'sort_by(.created_at) | reverse')

          # âœ… æˆåŠŸã—ãŸ human: æœ€æ–°7ä»¶ä¿æŒ
          KEEP_HUMAN=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.actor != "dependabot[bot]" and .conclusion == "success")][:7] | map(.id)')
          # âœ… æˆåŠŸã—ãŸ dependabot: æœ€æ–°3ä»¶ä¿æŒ
          KEEP_DEPENDABOT=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.actor == "dependabot[bot]" and .conclusion == "success")][:3] | map(.id)')
          # âœ… å¤±æ•—ï¼ˆéžsuccessï¼‰: æœ€æ–°1ä»¶ä¿æŒ
          KEEP_FAILED=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.conclusion != "success")][:1] | map(.id)')

          KEEP_ALL=$(jq -n --argjson a "$KEEP_HUMAN" --argjson b "$KEEP_DEPENDABOT" --argjson c "$KEEP_FAILED" '$a + $b + $c')

          TARGETS=$(echo "$ALL_RUNS" | jq -c --argjson keepIds "$KEEP_ALL" '[ .[] | select((.id as $id | ($keepIds | index($id)) | not)) ]')
          COUNT=$(echo "$TARGETS" | jq 'length')
          echo "ðŸ§¹ Found $COUNT runs to delete."

          if (( COUNT > 0 )); then
            echo "$TARGETS" | jq -c '.[]' | while read -r run; do
              ID=$(echo "$run" | jq -r '.id')
              NAME=$(echo "$run" | jq -r '.name')
              CONCLUSION=$(echo "$run" | jq -r '.conclusion')
              echo "ðŸ—‘ï¸ Deleting run $ID [$NAME] ($CONCLUSION)"
              gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "âš ï¸ Failed to delete run $ID"
              sleep 0.3
            done
          else
            echo "âœ… No old workflow runs to delete."
          fi

          echo "ðŸŽ‰ Cleanup complete (kept current + 7 human + 3 dependabot + 1 failed runs)"

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚µãƒžãƒªã‚’å‡ºåŠ›
        if: always()
        env:
          GH_TOKEN: ${{ steps.tok.outputs.token }}
        run: |
          REPO="${{ github.repository }}"
          TOTAL_RUNS=$(gh run list --limit 100 --json databaseId | jq 'length')

          echo "## ðŸ§¹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªãƒã‚¸ãƒˆãƒª**: \`$REPO\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¾åœ¨ã®ç·ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œæ•°**: \`$TOTAL_RUNS\` ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ ä¿æŒãƒãƒªã‚·ãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æˆåŠŸï¼ˆHumanï¼‰: æœ€æ–° **7ä»¶** ä¿æŒ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– æˆåŠŸï¼ˆDependabotï¼‰: æœ€æ–° **3ä»¶** ä¿æŒ" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ å¤±æ•—: æœ€æ–° **1ä»¶** ä¿æŒ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ ä¸Šè¨˜ä»¥å¤–: **å‰Šé™¤æ¸ˆã¿**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œæ—¥æ™‚: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ æ¬¡å›žå®šæœŸå®Ÿè¡Œ: 12æ™‚é–“ã”ã¨" >> $GITHUB_STEP_SUMMARY
