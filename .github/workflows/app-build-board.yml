name: app-build-board

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - "app/board-app/**"
      - ".github/workflows/app-build-board.yml"
  workflow_run:
    workflows:
      - infra-deploy
    types:
      - completed

permissions:
  contents: read
  id-token: write

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  BOARD_IMAGE_NAME: board-app

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: コードを取得
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Gitleaks で秘密情報を検出
        run: |
          set -euo pipefail
          VERSION="8.18.4"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz" -o gitleaks.tgz
          tar -xzf gitleaks.tgz gitleaks
          sudo install -m 755 gitleaks /usr/local/bin/gitleaks
          gitleaks detect --no-banner

      - name: Azure に OIDC でログイン
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ACR 名を解決
        id: resolve_acr
        run: |
          set -euo pipefail
          if [ -z "$ACR_NAME_PREFIX" ] || [ -z "$RESOURCE_GROUP_NAME" ]; then
            echo "ACR 名を決定するための変数が不足しています" >&2
            exit 1
          fi
          ACR_NAME=$(az acr list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" \
            -o tsv)
          if [ -z "$ACR_NAME" ]; then
            echo "指定プレフィックスの ACR が存在しません。infra-deploy を先に実行してください" >&2
            exit 1
          fi
          echo "ACR_NAME=$ACR_NAME" >> "$GITHUB_ENV"
          echo "ACR_LOGIN_SERVER=${ACR_NAME}.azurecr.io" >> "$GITHUB_ENV"
          echo "acr_login_server=${ACR_NAME}.azurecr.io" >> "$GITHUB_OUTPUT"

      - name: ACR へログイン
        run: |
          az acr login --name "$ACR_NAME"

      - name: イメージタグを決定
        id: image_meta
        run: |
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-12)"
          echo "IMAGE_TAG=$SHORT_SHA" >> "$GITHUB_ENV"
          echo "IMAGE_SHA_TAG=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: コンテナイメージをビルド
        run: |
          IMAGE_REF="$ACR_LOGIN_SERVER/$BOARD_IMAGE_NAME:${IMAGE_TAG}"
          docker build \
            --file app/board-app/Dockerfile \
            --tag "$IMAGE_REF" \
            app/board-app
          docker tag "$IMAGE_REF" "$ACR_LOGIN_SERVER/$BOARD_IMAGE_NAME:latest"

      - name: Trivy DB キャッシュ復元
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-${{ hashFiles('app/board-app/package.json') }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: コンテナ SBOM 生成 (CycloneDX)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.resolve_acr.outputs.acr_login_server }}/${{ env.BOARD_IMAGE_NAME }}:${{ steps.image_meta.outputs.IMAGE_SHA_TAG }}
          format: "cyclonedx"
          output: "sbom-board.cdx.json"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Trivy でコンテナをスキャン (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.resolve_acr.outputs.acr_login_server }}/${{ env.BOARD_IMAGE_NAME }}:${{ steps.image_meta.outputs.IMAGE_SHA_TAG }}
          format: "sarif"
          output: "trivy-image-board.sarif"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "1"

      - name: ソース/設定/シークレット総合スキャン (Trivy FS)
        run: |
          set -euo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./trivy-bin
          ./trivy-bin fs --scanners vuln,secret,config --ignore-unfixed --severity CRITICAL,HIGH \
            --format sarif --output trivy-fs-board.sarif app/board-app

      - name: Trivy SARIF をアップロード (Image)
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-image-board.sarif

      - name: Trivy SARIF をアップロード (FS)
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-fs-board.sarif

      - name: イメージを ACR へプッシュ
        run: |
          docker push "$ACR_LOGIN_SERVER/$BOARD_IMAGE_NAME:${IMAGE_TAG}"
          docker push "$ACR_LOGIN_SERVER/$BOARD_IMAGE_NAME:latest"

      - name: ビルド成果を記録
        run: |
          printf "image=%s\n" "$ACR_LOGIN_SERVER/$BOARD_IMAGE_NAME:${IMAGE_TAG}" | tee build-output.txt

      - name: 成果メタデータを保存
        uses: actions/upload-artifact@v4
        with:
          name: board-app-image
          path: |
            build-output.txt
            sbom-board.cdx.json
            trivy-image-board.sarif
            trivy-fs-board.sarif
