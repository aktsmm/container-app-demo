name: 2ï¸âƒ£ Build Admin App

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - "app/admin-app/**"
      - ".github/workflows/2-build-admin-app.yml"
  workflow_run:
    workflows:
      - "1ï¸âƒ£ Infrastructure Deploy"
    types:
      - completed

permissions:
  contents: read
  id-token: write

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  ADMIN_IMAGE_NAME: admin-app
  PARAM_FILE: infra/parameters/main-dev.parameters.json

jobs:
  prepare-build-context:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      checkout_ref: ${{ steps.detect_ref.outputs.checkout_ref }}
      image_tag: ${{ steps.detect_ref.outputs.image_tag }}
      acr_name: ${{ steps.resolve_acr.outputs.acr_name }}
      acr_login_server: ${{ steps.resolve_acr.outputs.acr_login_server }}
      resource_group_name: ${{ steps.resolve_acr.outputs.resource_group_name }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆã¨ã‚¿ã‚°ã‚’æ±ºå®š
        id: detect_ref
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            REF='${{ github.event.workflow_run.head_sha }}'
          else
            REF='${{ github.sha }}'
          fi
          SHORT_REF="${REF:0:12}"
          echo "checkout_ref=$REF" >> "$GITHUB_OUTPUT"
          echo "image_tag=$SHORT_REF" >> "$GITHUB_OUTPUT"
          echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚³ãƒŸãƒƒãƒˆ: $REF (tag=$SHORT_REF)"

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã¨ ACR ã‚’è§£æ±º
        id: resolve_acr
        run: |
          set -euo pipefail
          RG_NAME="$RESOURCE_GROUP_NAME"
          if [ -z "$RG_NAME" ]; then
            echo "ç’°å¢ƒå¤‰æ•° RESOURCE_GROUP_NAME ãŒç©ºã§ã™" >&2; exit 1; fi
          if ! az group show --name "$RG_NAME" &>/dev/null; then
            echo "âš ï¸ æŒ‡å®š RG '$RG_NAME' ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚parameters ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åç§°å†å–å¾—ã‚’è©¦ã¿ã¾ã™" >&2
            ALT_RG=$(grep -E '"resourceGroupName"' "$PARAM_FILE" | head -n1 | sed -E 's/.*"resourceGroupName".*"([^"]+)".*/\1/' || true)
            if [ -n "$ALT_RG" ] && az group show --name "$ALT_RG" &>/dev/null; then
              echo "ä»£æ›¿ RG ã‚’ä½¿ç”¨: $ALT_RG"
              RG_NAME="$ALT_RG"
            else
              echo "è‡´å‘½çš„: æœ‰åŠ¹ãªãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ (ç¾åœ¨: '$RESOURCE_GROUP_NAME')" >&2
              az group list --query '[].name' -o tsv >&2 || true
              exit 3
            fi
          fi
          if [ -z "$ACR_NAME_PREFIX" ] || [ -z "$RG_NAME" ]; then
            echo "ACR åã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®å¤‰æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™" >&2
            exit 1
          fi
          ACR_NAME=$(az acr list \
            --resource-group "$RG_NAME" \
            --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" \
            -o tsv)
          if [ -z "$ACR_NAME" ]; then
            echo "æŒ‡å®šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã® ACR ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚infra-deploy ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
            exit 1
          fi
          echo "acr_name=$ACR_NAME" >> "$GITHUB_OUTPUT"
          echo "acr_login_server=${ACR_NAME}.azurecr.io" >> "$GITHUB_OUTPUT"
          echo "resource_group_name=$RG_NAME" >> "$GITHUB_OUTPUT"

  code-security-scans:
    runs-on: ubuntu-latest
    needs: prepare-build-context
    if: ${{ needs.prepare-build-context.result == 'success' }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-build-context.outputs.checkout_ref }}

      - name: Gitleaks ã§ç§˜å¯†æƒ…å ±ã‚’æ¤œå‡º
        continue-on-error: true
        run: |
          set +e
          VERSION="8.18.4"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz" -o gitleaks.tgz
          tar -xzf gitleaks.tgz gitleaks
          sudo install -m 755 gitleaks /usr/local/bin/gitleaks
          gitleaks detect --no-banner --report-format sarif --report-path gitleaks-admin.sarif
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºã‚ã‚Šï¼ˆè­¦å‘Šï¼‰- Security ã‚¿ãƒ–ã§ç¢ºèªã—ã¦ãã ã•ã„"
          fi
          exit 0

      - name: ã‚½ãƒ¼ã‚¹/è¨­å®š/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç·åˆã‚¹ã‚­ãƒ£ãƒ³ (Trivy FS)
        continue-on-error: true
        run: |
          set -euo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./trivy-bin
          ./trivy-bin fs --scanners vuln,secret,config --ignore-unfixed --severity CRITICAL,HIGH \
            --format sarif --output trivy-fs-admin.sarif app/admin-app || echo "è„†å¼±æ€§æ¤œå‡ºã‚ã‚Šï¼ˆè­¦å‘Šï¼‰"

      - name: Trivy SARIF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (FS)
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-fs-admin.sarif

      - name: Gitleaks SARIF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gitleaks-admin.sarif

  build-and-push:
    runs-on: ubuntu-latest
    needs: [prepare-build-context, code-security-scans]
    if: ${{ needs.code-security-scans.result == 'success' }}
    env:
      CHECKOUT_REF: ${{ needs.prepare-build-context.outputs.checkout_ref }}
      IMAGE_TAG: ${{ needs.prepare-build-context.outputs.image_tag }}
      ACR_NAME: ${{ needs.prepare-build-context.outputs.acr_name }}
      ACR_LOGIN_SERVER: ${{ needs.prepare-build-context.outputs.acr_login_server }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ACR ç®¡ç†è€…èªè¨¼ã‚’æœ‰åŠ¹åŒ–
        run: |
          az acr update --name "$ACR_NAME" --admin-enabled true

      - name: ACR ã¸ãƒ­ã‚°ã‚¤ãƒ³
        run: |
          az acr login --name "$ACR_NAME"

      - name: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚’æ±ºå®š
        run: |
          echo "ãƒ“ãƒ«ãƒ‰ã‚¿ã‚°: ${IMAGE_TAG}"

      - name: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          IMAGE_REF="$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:${IMAGE_TAG}"
          docker build \
            --file app/admin-app/Dockerfile \
            --tag "$IMAGE_REF" \
            app/admin-app
          docker tag "$IMAGE_REF" "$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:latest"

      - name: Trivy DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-${{ hashFiles('app/admin-app/requirements.txt') }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: ã‚³ãƒ³ãƒ†ãƒŠ SBOM ç”Ÿæˆ (CycloneDX)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.ACR_LOGIN_SERVER }}/${{ env.ADMIN_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: "cyclonedx"
          output: "sbom-admin.cdx.json"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Trivy ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¹ã‚­ãƒ£ãƒ³ (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          image-ref: ${{ env.ACR_LOGIN_SERVER }}/${{ env.ADMIN_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: "sarif"
          output: "trivy-image-admin.sarif"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Trivy SARIF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Image)
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-image-admin.sarif

      - name: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ ACR ã¸ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          docker push "$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:${IMAGE_TAG}"
          docker push "$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:latest"

      - name: ãƒ“ãƒ«ãƒ‰ã‚µãƒžãƒªã‚’å‡ºåŠ›
        if: success()
        run: |
          echo "## ðŸŽ¯ ç®¡ç†ã‚¢ãƒ—ãƒª ãƒ“ãƒ«ãƒ‰å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ¬ã‚¸ã‚¹ãƒˆãƒª**: \`$ACR_LOGIN_SERVER\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¤ãƒ¡ãƒ¼ã‚¸å**: \`$ADMIN_IMAGE_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚°**: \`${IMAGE_TAG}\`, \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ•ãƒ«ãƒ‘ã‚¹**: \`$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Gitleaks**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³å®Œäº† â†’ [Security ã‚¿ãƒ–ã§ç¢ºèª](/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy (Image)**: è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³å®Œäº† â†’ [Security ã‚¿ãƒ–ã§ç¢ºèª](/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy (FS)**: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³å®Œäº† â†’ [Security ã‚¿ãƒ–ã§ç¢ºèª](/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æˆæžœç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM (CycloneDX)" >> $GITHUB_STEP_SUMMARY
          echo "- SARIF ãƒ¬ãƒãƒ¼ãƒˆ (Trivy, Gitleaks)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ ã‚³ãƒŸãƒƒãƒˆ: \`${CHECKOUT_REF:0:12}\`" >> $GITHUB_STEP_SUMMARY

      - name: ãƒ“ãƒ«ãƒ‰æˆæžœã‚’è¨˜éŒ²
        run: |
          printf "image=%s\n" "$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:${IMAGE_TAG}" | tee build-output.txt

      - name: æˆæžœãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: admin-app-image
          path: |
            build-output.txt
            sbom-admin.cdx.json
            trivy-image-admin.sarif

  post-build-summary:
    runs-on: ubuntu-latest
    needs: [prepare-build-context, build-and-push]
    if: ${{ needs.build-and-push.result == 'success' }}
    env:
      ACR_LOGIN_SERVER: ${{ needs.prepare-build-context.outputs.acr_login_server }}
      IMAGE_TAG: ${{ needs.prepare-build-context.outputs.image_tag }}
      CHECKOUT_REF: ${{ needs.prepare-build-context.outputs.checkout_ref }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: ãƒ“ãƒ«ãƒ‰ã‚µãƒžãƒªã‚’å†æŽ²
        run: |
          echo "## ðŸŽ¯ ç®¡ç†ã‚¢ãƒ—ãƒª ãƒ“ãƒ«ãƒ‰å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ¬ã‚¸ã‚¹ãƒˆãƒª**: \`$ACR_LOGIN_SERVER\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¤ãƒ¡ãƒ¼ã‚¸å**: \`$ADMIN_IMAGE_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚°**: \`${IMAGE_TAG}\`, \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ•ãƒ«ãƒ‘ã‚¹**: \`$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Gitleaks**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³å®Œäº† â†’ [Security ã‚¿ãƒ–ã§ç¢ºèª](/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy (Image)**: è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³å®Œäº† â†’ [Security ã‚¿ãƒ–ã§ç¢ºèª](/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy (FS)**: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³å®Œäº† â†’ [Security ã‚¿ãƒ–ã§ç¢ºèª](/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æˆæžœç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM (CycloneDX)" >> $GITHUB_STEP_SUMMARY
          echo "- SARIF ãƒ¬ãƒãƒ¼ãƒˆ (Trivy, Gitleaks)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ ã‚³ãƒŸãƒƒãƒˆ: \`${CHECKOUT_REF:0:12}\`" >> $GITHUB_STEP_SUMMARY
