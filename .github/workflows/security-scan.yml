name: ğŸ” Security Scan (CodeQL & IaC)

on:
  push:
    branches: [master]
    paths:
      - "app/board-app/**"
      - "app/admin-app/**"
      - "infra/**"
      - ".github/workflows/codeql-iac-scan.yml"
  pull_request:
    branches: [master]
    paths:
      - "app/board-app/**"
      - "app/admin-app/**"
      - "infra/**"
  schedule:
    - cron: "0 3 * * *" # æ¯æ—¥ 03:00 UTC (JST åˆå‰ 12æ™‚) å®šæœŸã‚¹ã‚­ãƒ£ãƒ³
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  CODEQL_LANGUAGES: "javascript,python"

jobs:
  codeql:
    name: CodeQL (JS+Python)
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v4

      - name: CodeQL åˆæœŸåŒ–
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ env.CODEQL_LANGUAGES }}
          queries: security-extended # è¿½åŠ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹¡å¼µã‚¯ã‚¨ãƒª

      - name: è‡ªå‹•ãƒ“ãƒ«ãƒ‰
        uses: github/codeql-action/autobuild@v3

      - name: CodeQL è§£æ
        uses: github/codeql-action/analyze@v3
        with:
          category: "codeql"

  iac-security:
    name: IaC ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (Bicep/K8s/Secrets)
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v4

      - name: Trivy DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-${{ hashFiles('infra/**/*.bicep') }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: Trivy CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          set -euo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Bicep (infra/) è¨­å®š & ç§˜å¯†æƒ…å ± & ãƒŸã‚¹ã‚³ãƒ³ãƒ•ã‚£ã‚° ã‚¹ã‚­ãƒ£ãƒ³ (SARIF)
        run: |
          set -euo pipefail
          trivy fs infra \
            --scanners config,secret \
            --severity CRITICAL,HIGH,MEDIUM \
            --format sarif --output trivy-infra.sarif \
            --ignore-unfixed

      - name: Kubernetes ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ (board-app/k8s) ã‚¹ã‚­ãƒ£ãƒ³ (SARIF)
        run: |
          set -euo pipefail
          trivy fs app/board-app/k8s \
            --scanners config,secret \
            --severity CRITICAL,HIGH,MEDIUM \
            --format sarif --output trivy-k8s.sarif \
            --ignore-unfixed

      - name: Trivy SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (infra)
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-infra.sarif

      - name: Trivy SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (k8s)
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-k8s.sarif

      - name: ã‚¹ã‚­ãƒ£ãƒ³æˆæœç‰©ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: iac-scan-results
          path: |
            trivy-infra.sarif
            trivy-k8s.sarif

  summary:
    name: ã¾ã¨ã‚ãƒ¬ãƒãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    needs: [codeql, iac-security]
    steps:
      - name: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆ
        run: |
          echo "CodeQL & IaC ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ã€‚Security ã‚¿ãƒ–ã§ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„" > summary.txt
      - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: summary.txt
# ã‚³ãƒ¡ãƒ³ãƒˆ:
# - CodeQL: JavaScript(React/Vite) ã¨ Python(FastAPI/Flaskç­‰) ã‚’ security-extended ã‚¯ã‚¨ãƒªã§è§£æã€‚
# - IaC: Bicep ã¨ Kubernetes YAML ã‚’ Trivy config+secret ã‚¹ã‚­ãƒ£ãƒŠã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã€ãƒŸã‚¹ã‚³ãƒ³ãƒ•ã‚£ã‚°/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ã‚’æ¤œå‡ºã€‚
# - SARIF: GitHub Security(Code scanning alerts) ã«é›†ç´„ã—ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼åŠ¹ç‡åŒ–ã€‚
# - å®šæœŸå®Ÿè¡Œ: cron ã«ã‚ˆã‚Šæ—¥æ¬¡ã®ãƒ‰ãƒªãƒ•ãƒˆ/æ–°è¦è„†å¼±æ€§æ¤œçŸ¥ã‚’è‡ªå‹•åŒ–ã€‚
# - å¤±æ•—æ¡ä»¶: ç¾çŠ¶ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã¿ã§ gating ã›ãšã€‚å¿…è¦ãªã‚‰ --exit-code 1 ã‚’è¿½åŠ ã— PR ãƒ–ãƒ­ãƒƒã‚¯å¯èƒ½ã€‚
