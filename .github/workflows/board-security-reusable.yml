name: â™» Board Security Scan (Reusable)
run-name: "â™» Board Security Scan â€“ triggered by ${{ github.actor }}"

on:
    workflow_call:
        outputs:
            gitguardian_issues:
                description: GitGuardian ã®æ¤œå‡ºä»¶æ•°
                value: ${{ jobs.gitguardian-scan.outputs.gitguardian_issues }}
            gitguardian_has_key:
                description: GitGuardian API ã‚­ãƒ¼ã®æœ‰ç„¡
                value: ${{ jobs.gitguardian-scan.outputs.has_key }}
            gitguardian_scan_error:
                description: GitGuardian ã‚¹ã‚­ãƒ£ãƒ³çµæœã®ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥
                value: ${{ jobs.gitguardian-scan.outputs.scan_error }}

jobs:
    # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—2: Gitleaks (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º)
    gitleaks-scan:
        name: Gitleaks (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º)
        runs-on: ubuntu-latest
        steps:
            - name: ã‚³ãƒ¼ãƒ‰å–å¾—
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

            - name: Gitleaks ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
              uses: actions/cache@v4
              with:
                  path: ~/.cache/gitleaks
                  key: gitleaks-${{ runner.os }}-${{ github.sha }}
                  restore-keys: |
                      gitleaks-${{ runner.os }}-

            - name: Gitleaks ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: |
                  set -euo pipefail
                  VERSION="8.18.4"
                  curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz" -o gitleaks.tgz
                  tar -xzf gitleaks.tgz gitleaks
                  sudo install -m 755 gitleaks /usr/local/bin/gitleaks
                  gitleaks version

            - name: Gitleaks ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º (å…¨ãƒªãƒã‚¸ãƒˆãƒª)
              continue-on-error: true
              run: |
                  set +e
                  gitleaks detect --no-banner --report-format sarif --report-path gitleaks-repo.sarif
                  EXIT_CODE=$?
                  if [ $EXIT_CODE -ne 0 ]; then
                    echo "âš ï¸ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºã‚ã‚Šï¼ˆè­¦å‘Šï¼‰- Security ã‚¿ãƒ–ã§ç¢ºèªã—ã¦ãã ã•ã„"
                  fi
                  exit 0

            - name: Gitleaks SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
              if: github.actor != 'dependabot[bot]'
              uses: github/codeql-action/upload-sarif@v4
              continue-on-error: true
              with:
                  sarif_file: gitleaks-repo.sarif
                  category: gitleaks

            - name: Gitleaks SARIF ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: gitleaks-sarif
                  path: gitleaks-repo.sarif
                  if-no-files-found: warn

    # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—2-B: GitGuardian (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºãƒ»å¼·åŒ–ç‰ˆ)
    gitguardian-scan:
        name: GitGuardian (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º)
        runs-on: ubuntu-latest
        outputs:
            gitguardian_issues: ${{ steps.count_issues.outputs.issues }}
            has_key: ${{ steps.check-api-key.outputs.has_key }}
            scan_error: ${{ steps.gg_scan.outputs.scan_error }}
        steps:
            - name: ã‚³ãƒ¼ãƒ‰å–å¾—
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

            - name: GitGuardian API ã‚­ãƒ¼ç¢ºèª
              id: check-api-key
              run: |
                  if [ -z "${{ vars.GITGUARDIAN_API_KEY }}" ]; then
                    echo "âš ï¸ GitGuardian API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰"
                    echo "è¨­å®šæ–¹æ³•:"
                    echo "1. https://dashboard.gitguardian.com/api/personal-access-tokens ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ"
                    echo "2. Settings â†’ Variables â†’ New repository variable"
                    echo "3. Name: GITGUARDIAN_API_KEY, Value: <ç”Ÿæˆã—ãŸãƒˆãƒ¼ã‚¯ãƒ³>"
                    echo "has_key=false" >> $GITHUB_OUTPUT
                  else
                    echo "âœ… GitGuardian API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
                    echo "has_key=true" >> $GITHUB_OUTPUT
                  fi

            - name: GitGuardian ã‚¹ã‚­ãƒ£ãƒ³
              id: gg_scan
              if: steps.check-api-key.outputs.has_key == 'true'
              continue-on-error: true
              run: |
                  set +e
                  # ggshield ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                  pip install --quiet ggshield

                  # JSON å½¢å¼ã§ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œã¨ã‚¨ãƒ©ãƒ¼æ•æ‰
                  SCAN_OUTPUT=$(ggshield secret scan repo . --json --output gitguardian-results.json 2>&1)
                  SCAN_EXIT_CODE=$?

                  # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
                  if echo "$SCAN_OUTPUT" | grep -q "Token is missing the required scope"; then
                    echo "::error::âŒ GitGuardian API Key ã« 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
                    echo ""
                    echo "ğŸ“‹ è§£æ±ºæ‰‹é †:"
                    echo "1. https://dashboard.gitguardian.com/api/personal-access-tokens ã«ã‚¢ã‚¯ã‚»ã‚¹"
                    echo "2. æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’é¸æŠ:"
                    echo "   âœ… scan (å¿…é ˆ)"
                    echo "   âœ… incident:read"
                    echo "   âœ… incident:write"
                    echo "3. GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Settings â†’ Secrets and variables â†’ Variables"
                    echo "4. GITGUARDIAN_API_KEY ã‚’æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã§æ›´æ–°"
                    echo ""
                    echo "è©³ç´°: trouble_docs/2025-11-24-gitguardian-api-key-scope.md"
                    echo "scan_error=scope_missing" >> "$GITHUB_OUTPUT"
                    exit 1
                  elif echo "$SCAN_OUTPUT" | grep -q -E "(401|403|Unauthorized|Forbidden)"; then
                    echo "::error::âŒ GitGuardian API Key ãŒç„¡åŠ¹ã¾ãŸã¯æ¨©é™ä¸è¶³ã§ã™"
                    echo ""
                    echo "ğŸ“‹ è§£æ±ºæ‰‹é †:"
                    echo "1. API Key ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
                    echo "2. API Key ã« 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
                    echo "3. https://dashboard.gitguardian.com/api/personal-access-tokens ã§æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ"
                    echo "scan_error=auth_failed" >> "$GITHUB_OUTPUT"
                    exit 1
                  elif [ $SCAN_EXIT_CODE -ne 0 ] && [ ! -f gitguardian-results.json ]; then
                    echo "::warning::âš ï¸ GitGuardian ã‚¹ã‚­ãƒ£ãƒ³ãŒå¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶™ç¶šã—ã¾ã™"
                    echo "$SCAN_OUTPUT"
                    echo "scan_error=unknown" >> "$GITHUB_OUTPUT"
                  else
                    echo "âœ… GitGuardian ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
                    echo "scan_error=none" >> "$GITHUB_OUTPUT"
                  fi

                  # æ¤œå‡ºãŒã‚ã‚‹ã‹ç¢ºèª
                  if [ -f gitguardian-results.json ] && [ -s gitguardian-results.json ]; then
                    echo "âœ… GitGuardian ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’å–å¾—"
                  else
                    echo "âš ï¸ ã‚¹ã‚­ãƒ£ãƒ³çµæœãªã—"
                    echo '{"secrets":[]}' > gitguardian-results.json
                  fi

                  exit 0
              env:
                  GITGUARDIAN_API_KEY: ${{ vars.GITGUARDIAN_API_KEY }}

            - name: GitGuardian æœªè¨­å®šæ™‚ã®ç©ºãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
              if: steps.check-api-key.outputs.has_key == 'false'
              run: |
                  echo '{"secrets":[]}' > gitguardian-results.json

            - name: GitGuardian çµæœã‚’ SARIF å¤‰æ›
              continue-on-error: true
              run: |
                  cat > convert-gg-to-sarif.py << 'PYEOF'
                  import json
                  import sys
                  from datetime import datetime

                  # GitGuardian JSON ã‚’èª­ã¿è¾¼ã¿
                  try:
                      with open('gitguardian-results.json', 'r', encoding='utf-8') as f:
                          gg_data = json.load(f)
                  except:
                      gg_data = {"scans": []}

                  # SARIF ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”Ÿæˆ
                  sarif = {
                      "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
                      "version": "2.1.0",
                      "runs": [{
                          "tool": {
                              "driver": {
                                  "name": "GitGuardian",
                                  "version": "1.0",
                                  "informationUri": "https://www.gitguardian.com/"
                              }
                          },
                          "results": []
                      }]
                  }

                  # GitGuardian ã®å®Ÿéš›ã® JSON æ§‹é€ ã‚’è§£æ
                  # æ§‹é€ : { "scans": [ { "entities_with_incidents": [ { "filename": "...", "incidents": [...] } ] } ] }
                  if isinstance(gg_data, dict) and "scans" in gg_data:
                      scans = gg_data.get("scans", [])
                      for scan in scans:
                          if not isinstance(scan, dict):
                              continue

                          # å„ã‚³ãƒŸãƒƒãƒˆã® entities_with_incidents ã‚’å‡¦ç†
                          entities = scan.get("entities_with_incidents", [])
                          for entity in entities:
                              if not isinstance(entity, dict):
                                  continue

                              filename = entity.get("filename", "unknown")
                              incidents = entity.get("incidents", [])

                              # å„ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚’ SARIF ã«å¤‰æ›
                              for incident in incidents:
                                  if not isinstance(incident, dict):
                                      continue

                                  incident_type = incident.get("type", "secret-detected")
                                  policy = incident.get("policy", "Secrets detection")
                                  occurrences = incident.get("occurrences", [])

                                  # æœ€åˆã® occurrence ã‹ã‚‰ä½ç½®æƒ…å ±ã‚’å–å¾—
                                  line_start = 1
                                  line_end = 1
                                  if occurrences and isinstance(occurrences, list) and len(occurrences) > 0:
                                      first_occ = occurrences[0]
                                      if isinstance(first_occ, dict):
                                          line_start = first_occ.get("line_start", 1)
                                          line_end = first_occ.get("line_end", line_start)

                                  # SARIF result ã«è¿½åŠ 
                                  sarif["runs"][0]["results"].append({
                                      "ruleId": f"gitguardian/{incident_type}",
                                      "level": "error",
                                      "message": {
                                          "text": f"GitGuardian detected {incident_type} in {filename}"
                                      },
                                      "locations": [{
                                          "physicalLocation": {
                                              "artifactLocation": {
                                                  "uri": filename
                                              },
                                              "region": {
                                                  "startLine": line_start,
                                                  "endLine": line_end
                                              }
                                          }
                                      }],
                                      "properties": {
                                          "severity": "HIGH",
                                          "policy": policy
                                      }
                                  })

                  # SARIF ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
                  with open('gitguardian-repo.sarif', 'w', encoding='utf-8') as f:
                      json.dump(sarif, f, indent=2, ensure_ascii=False)

                  print(f"âœ… SARIF å¤‰æ›å®Œäº†: {len(sarif['runs'][0]['results'])} ä»¶ã®æ¤œå‡º")
                  PYEOF

                  python convert-gg-to-sarif.py

            - name: GitGuardian SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
              if: steps.check-api-key.outputs.has_key == 'true' && github.actor != 'dependabot[bot]'
              uses: github/codeql-action/upload-sarif@v4
              continue-on-error: true
              with:
                  sarif_file: gitguardian-repo.sarif
                  category: gitguardian

            - name: æ¤œå‡ºæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
              id: count_issues
              if: always()
              run: |
                  if [ -f gitguardian-repo.sarif ]; then
                    ISSUES=$(jq '.runs[0].results | length' gitguardian-repo.sarif 2>/dev/null || echo "0")
                  else
                    ISSUES=0
                  fi
                  echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"
                  echo "GitGuardian: $ISSUES ä»¶ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º"

                  # ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆã‚µãƒãƒªã«ã¯æ›¸ãè¾¼ã¾ãªã„ï¼‰
                  SCAN_ERROR="${{ steps.gg_scan.outputs.scan_error || 'none' }}"
                  HAS_KEY="${{ steps.check-api-key.outputs.has_key }}"

                  if [ "$HAS_KEY" != "true" ]; then
                    echo "âš ï¸ GitGuardian API Key æœªè¨­å®š - ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
                  elif [ "$SCAN_ERROR" = "scope_missing" ]; then
                    echo "âŒ GitGuardian API Key ã« 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
                  elif [ "$SCAN_ERROR" = "auth_failed" ]; then
                    echo "âŒ GitGuardian èªè¨¼ã‚¨ãƒ©ãƒ¼ - API Key ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
                  elif [ "$SCAN_ERROR" != "none" ]; then
                    echo "âš ï¸ GitGuardian ã‚¹ã‚­ãƒ£ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
                  fi

            - name: GitGuardian çµæœã‚’ Artifact ã¨ã—ã¦ä¿å­˜
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: gitguardian-results
                  path: |
                      gitguardian-repo.sarif
                      gitguardian-results.json
                  retention-days: 7
                  if-no-files-found: warn

    # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—3: Trivy IaC ã‚¹ã‚­ãƒ£ãƒ³ (Bicep/K8s)
    trivy-iac:
        name: Trivy IaC (Bicep/K8s)
        runs-on: ubuntu-latest
        steps:
            - name: ã‚³ãƒ¼ãƒ‰å–å¾—
              uses: actions/checkout@v4

            - name: Trivy DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
              uses: actions/cache@v4
              with:
                  path: ~/.cache/trivy
                  key: trivy-db-${{ runner.os }}-${{ hashFiles('infra/**/*.bicep', 'app/**/k8s/**/*.yaml') }}
                  restore-keys: |
                      trivy-db-${{ runner.os }}-

            - name: Trivy CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              run: |
                  set -euo pipefail
                  curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
                  trivy --version

            - name: Bicep (infra/) è¨­å®š & ç§˜å¯†æƒ…å ± & ãƒŸã‚¹ã‚³ãƒ³ãƒ•ã‚£ã‚° ã‚¹ã‚­ãƒ£ãƒ³ (SARIF)
              continue-on-error: true
              run: |
                  set -euo pipefail
                  trivy fs infra \
                    --scanners config,secret \
                    --severity CRITICAL,HIGH,MEDIUM \
                    --format sarif --output trivy-infra.sarif \
                    --ignore-unfixed

            - name: Kubernetes ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ (board-app/k8s) ã‚¹ã‚­ãƒ£ãƒ³ (SARIF)
              continue-on-error: true
              run: |
                  set -euo pipefail
                  trivy fs app/board-app/k8s \
                    --scanners config,secret \
                    --severity CRITICAL,HIGH,MEDIUM \
                    --format sarif --output trivy-k8s.sarif \
                    --ignore-unfixed

            - name: Trivy SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (infra)
              if: github.actor != 'dependabot[bot]'
              uses: github/codeql-action/upload-sarif@v4
              continue-on-error: true
              with:
                  sarif_file: trivy-infra.sarif
                  category: trivy-infra

            - name: Trivy SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (k8s)
              if: github.actor != 'dependabot[bot]'
              uses: github/codeql-action/upload-sarif@v4
              continue-on-error: true
              with:
                  sarif_file: trivy-k8s.sarif
                  category: trivy-k8s

            - name: Trivy IaC SARIF ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: trivy-iac-sarif
                  path: |
                      trivy-infra.sarif
                      trivy-k8s.sarif
                  if-no-files-found: warn
