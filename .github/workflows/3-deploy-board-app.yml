name: 3ï¸âƒ£ Deploy Board App (AKS)

on:
    workflow_dispatch:
        inputs:
            imageTag:
                description: "ACR ã«ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° (æœªæŒ‡å®šæ™‚ã¯ latest)"
                required: false
    workflow_run:
        workflows:
            - "2ï¸âƒ£ Build Board App"
        types:
            - completed

permissions:
    contents: read
    id-token: write

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  AKS_CLUSTER_NAME: ${{ vars.AKS_CLUSTER_NAME }}
  PARAM_FILE: infra/parameters/main-dev.parameters.json
  KUSTOMIZE_DIR: app/board-app/k8s
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  BOARD_IMAGE_NAME: board-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    # build ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµŒç”±ã®ã¨ãã®ã¿è‡ªå‹•å®Ÿè¡Œã—ã€å¤±æ•— run ã¯é™¤å¤–ã™ã‚‹
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Azure ã« OIDC ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ACR åã‚’è§£æ±º
        run: |
          set -euo pipefail
          if [ -z "$ACR_NAME_PREFIX" ] || [ -z "$RESOURCE_GROUP_NAME" ]; then
            echo "ACR åã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®å¤‰æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™" >&2
            exit 1
          fi
          ACR_NAME=$(az acr list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" \
            -o tsv)
          if [ -z "$ACR_NAME" ]; then
            echo "æŒ‡å®šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã® ACR ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚infra-deploy ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
            exit 1
          fi
          echo "ACR_NAME=$ACR_NAME" >> "$GITHUB_ENV"
          echo "ACR_LOGIN_SERVER=${ACR_NAME}.azurecr.io" >> "$GITHUB_ENV"

      - name: kubectl ã‚’æº–å‚™
        run: az aks install-cli

      - name: Namespace/Ingress ã®å€¤ã‚’åŒæœŸ
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          & ./scripts/sync-board-vars.ps1 `
            -ParametersFile "infra/parameters/main-dev.parameters.json" `
            -OutputFile "app/board-app/k8s/vars.env"

      - name: AKS ã« ACR Pull æ¨©é™ã‚’ä»˜ä¸Ž
        continue-on-error: true
        run: |
          # ACR Pull æ¨©é™ãŒæ—¢ã«ä»˜ä¸Žã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if az aks check-acr --name "$AKS_CLUSTER_NAME" --resource-group "$RESOURCE_GROUP_NAME" --acr "${ACR_LOGIN_SERVER}" &>/dev/null; then
            echo "ACR Pull æ¨©é™ã¯æ—¢ã«ä»˜ä¸Žã•ã‚Œã¦ã„ã¾ã™"
          else
            echo "ACR Pull æ¨©é™ã‚’ä»˜ä¸Žã—ã¾ã™"
            az aks update \
              --name "$AKS_CLUSTER_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --attach-acr "$ACR_NAME" || echo "âš ï¸ ACR æ¨©é™ä»˜ä¸Žã«å¤±æ•—ã—ã¾ã—ãŸãŒã€æ—¢å­˜ã®æ¨©é™ã§ç¶™ç¶šã—ã¾ã™"
          fi

      - name: AKS è³‡æ ¼æƒ…å ±ã‚’å–å¾—
        run: |
          az aks get-credentials \
            --name "$AKS_CLUSTER_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --overwrite-existing

      - name: ACR ç®¡ç†è€…èªè¨¼ã‚’æœ‰åŠ¹åŒ–
        run: |
          az acr update --name "$ACR_NAME" --admin-enabled true

      - name: ACR èªè¨¼æƒ…å ±ã§ Secret ã‚’ä½œæˆ
        run: |
          BOARD_NS=$(grep kubernetesNamespace "${KUSTOMIZE_DIR}/vars.env" | cut -d'=' -f2)
          # namespace ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          kubectl create namespace "$BOARD_NS" --dry-run=client -o yaml | kubectl apply -f -
          # ACR èªè¨¼æƒ…å ±ã‚’å–å¾—
          ACR_USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)
          # Secret ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°
          kubectl create secret docker-registry acr-secret \
            --docker-server="$ACR_LOGIN_SERVER" \
            --docker-username="$ACR_USERNAME" \
            --docker-password="$ACR_PASSWORD" \
            -n "$BOARD_NS" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã«ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ±ºå®š
        id: image_meta
        run: |
          EVENT_NAME='${{ github.event_name }}'
          if [ "$EVENT_NAME" = 'workflow_run' ]; then
            HEAD_SHA='${{ github.event.workflow_run.head_sha }}'
            IMAGE_TAG="${HEAD_SHA:0:12}"
          else
            IMAGE_TAG='${{ github.event.inputs.imageTag }}'
          fi
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG='latest'
          fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> "$GITHUB_ENV"
          echo "IMAGE_FULL=$ACR_LOGIN_SERVER/$BOARD_IMAGE_NAME:$IMAGE_TAG" >> "$GITHUB_ENV"

      - name: Kustomize ã‚’é©ç”¨
        run: |
          BOARD_NS=$(grep kubernetesNamespace "${KUSTOMIZE_DIR}/vars.env" | cut -d'=' -f2)
          kubectl kustomize "$KUSTOMIZE_DIR" \
            | sed "s#acr-placeholder.azurecr.io/board-app:latest#${IMAGE_FULL}#g" \
            | kubectl apply -f -
          kubectl rollout status deployment/board-app -n "$BOARD_NS" --timeout=120s
          kubectl get ingress -n "$BOARD_NS"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒžãƒªã‚’å‡ºåŠ›
        if: success()
        run: |
          BOARD_NS=$(grep kubernetesNamespace "${KUSTOMIZE_DIR}/vars.env" | cut -d'=' -f2)
          INGRESS_HOST=$(grep ingressHost "${KUSTOMIZE_DIR}/vars.env" | cut -d'=' -f2)
          
          # Load Balancer ã® Public IP ã‚’å–å¾—ï¼ˆNGINX Ingress Controller ã®ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ï¼‰
          LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          
          # IP ãŒå–å¾—ã§ããªã„å ´åˆã¯ LoadBalancer Service ã‚’æŽ¢ã™
          if [ -z "$LB_IP" ]; then
            LB_IP=$(kubectl get svc -A -o json | jq -r '.items[] | select(.spec.type=="LoadBalancer") | .status.loadBalancer.ingress[0].ip' | head -n1 2>/dev/null || echo "")
          fi

          echo "## ðŸŽ¯ æŽ²ç¤ºæ¿ã‚¢ãƒ—ãƒª AKS ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **AKS ã‚¯ãƒ©ã‚¹ã‚¿**: \`$AKS_CLUSTER_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: \`$BOARD_NS\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¤ãƒ¡ãƒ¼ã‚¸**: \`$IMAGE_FULL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“ ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "$LB_IP" ]; then
            echo "- **Load Balancer IP**: \`$LB_IP\`" >> $GITHUB_STEP_SUMMARY
            echo "- **ã‚¢ã‚¯ã‚»ã‚¹URL**: http://$LB_IP" >> $GITHUB_STEP_SUMMARY
            echo "- **ãƒ€ãƒŸãƒ¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**: http://$LB_IP/dummy-secret.txt" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ðŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã§ä¸Šè¨˜ IP ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Ingress ãƒ›ã‚¹ãƒˆ**: \`$INGRESS_HOST\`" >> $GITHUB_STEP_SUMMARY
            echo "- **âš ï¸ Load Balancer IP å–å¾—å¤±æ•—**: ã¾ã  IP ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ðŸ’¡ æ•°åˆ†å¾Œã« \`kubectl get svc -A | grep LoadBalancer\` ã§ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“¦ Pod çŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n "$BOARD_NS" -l app=board-app >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸŒ Ingress çŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n "$BOARD_NS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
