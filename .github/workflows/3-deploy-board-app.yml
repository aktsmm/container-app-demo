name: 3ï¸âƒ£ Deploy Board App (AKS)

on:
  workflow_dispatch:
    inputs:
      imageTag:
        description: "ACR ã«ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° (æœªæŒ‡å®šæ™‚ã¯ latest)"
        required: false
  workflow_run:
    workflows:
      - "2ï¸âƒ£ Build Board App"
      - "1ï¸âƒ£ Infrastructure Deploy"
    types:
      - completed

permissions:
  contents: read
  id-token: write
  actions: read  # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ workflow ãƒªã‚¹ãƒˆå–å¾—ã«å¿…è¦

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  AKS_CLUSTER_NAME: ${{ vars.AKS_CLUSTER_NAME }}
  PARAM_FILE: infra/parameters/main-dev.parameters.json
  KUSTOMIZE_DIR: app/board-app/k8s
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  BOARD_IMAGE_NAME: board-app
  BOARD_API_IMAGE_NAME: board-api
  DB_APP_USERNAME: ${{ vars.DB_APP_USERNAME }}
  DB_APP_PASSWORD: ${{ vars.DB_APP_PASSWORD }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    # build ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµŒç”±ã®ã¨ãã®ã¿è‡ªå‹•å®Ÿè¡Œã—ã€å¤±æ•— run ã¯é™¤å¤–ã™ã‚‹
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ã‚¤ãƒ³ãƒ•ãƒ©å‡ºåŠ›ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ MySQL IP ã‚’å–å¾—
        id: mysql_endpoint
        env:
          GH_TOKEN: ${{ github.token }}
          INFRA_WORKFLOW_NAME: "1ï¸âƒ£ Infrastructure Deploy"
        run: |
          set -euo pipefail
          mkdir -p infra-output
          if [ "${{ github.event_name }}" = "workflow_run" ] && [ "${{ github.event.workflow_run.name }}" = "$INFRA_WORKFLOW_NAME" ]; then
            TARGET_RUN_ID='${{ github.event.workflow_run.id }}'
            echo "workflow_run ãƒˆãƒªã‚¬ãƒ¼: run_id=$TARGET_RUN_ID"
          else
            # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯ GitHub REST API çµŒç”±ã§æ¤œç´¢ï¼ˆgh run list ãŒ workflow æ¨©é™ä¸è¶³ã§å¤±æ•—ã™ã‚‹å ´åˆã®å›é¿ç­–ï¼‰
            TARGET_RUN_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/1-infra-deploy.yml/runs?status=success&per_page=1" \
              | jq -r '.workflow_runs[0].id')
            echo "æ‰‹å‹•å®Ÿè¡Œ: æœ€æ–°ã®æˆåŠŸã—ãŸ Infrastructure Deploy run_id=$TARGET_RUN_ID"
          fi
          if [ -z "$TARGET_RUN_ID" ] || [ "$TARGET_RUN_ID" = "null" ]; then
            echo "ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Ÿè¡Œå±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >&2
            exit 1
          fi
          gh run download "$TARGET_RUN_ID" --name infra-outputs --dir infra-output >/dev/null
          OUTPUT_FILE=$(find infra-output -name '*.json' | head -n1)
          if [ -z "$OUTPUT_FILE" ]; then
            echo "infra-outputs ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã« JSON ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“" >&2
            exit 1
          fi
          MYSQL_IP=$(jq -r '.mysqlPrivateIp.value' "$OUTPUT_FILE")
          if [ -z "$MYSQL_IP" ] || [ "$MYSQL_IP" = "null" ]; then
            echo "infra å‡ºåŠ›ã« mysqlPrivateIp ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
            exit 1
          fi
          echo "DB_ENDPOINT=${MYSQL_IP}:3306" >> "$GITHUB_ENV"
          echo "Resolved MySQL endpoint: ${MYSQL_IP}:3306"

      - name: ACR åã‚’è§£æ±º
        run: |
          set -euo pipefail
          if [ -z "$ACR_NAME_PREFIX" ] || [ -z "$RESOURCE_GROUP_NAME" ]; then
            echo "ACR åã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®å¤‰æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™" >&2
            exit 1
          fi
          ACR_NAME=$(az acr list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" \
            -o tsv)
          if [ -z "$ACR_NAME" ]; then
            echo "æŒ‡å®šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã® ACR ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚infra-deploy ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
            exit 1
          fi
          echo "ACR_NAME=$ACR_NAME" >> "$GITHUB_ENV"
          echo "ACR_LOGIN_SERVER=${ACR_NAME}.azurecr.io" >> "$GITHUB_ENV"

      - name: kubectl ã‚’æº–å‚™
        run: az aks install-cli

      - name: Namespace/Ingress ã®å€¤ã‚’åŒæœŸ
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          & ./scripts/sync-board-vars.ps1 `
            -ParametersFile "infra/parameters/main-dev.parameters.json" `
            -OutputFile "app/board-app/k8s/vars.env"

      - name: AKS ã« ACR Pull æ¨©é™ã‚’ä»˜ä¸
        continue-on-error: true
        run: |
          # ACR Pull æ¨©é™ãŒæ—¢ã«ä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if az aks check-acr --name "$AKS_CLUSTER_NAME" --resource-group "$RESOURCE_GROUP_NAME" --acr "${ACR_LOGIN_SERVER}" &>/dev/null; then
            echo "ACR Pull æ¨©é™ã¯æ—¢ã«ä»˜ä¸ã•ã‚Œã¦ã„ã¾ã™"
          else
            echo "ACR Pull æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™"
            az aks update \
              --name "$AKS_CLUSTER_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --attach-acr "$ACR_NAME" || echo "âš ï¸ ACR æ¨©é™ä»˜ä¸ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€æ—¢å­˜ã®æ¨©é™ã§ç¶™ç¶šã—ã¾ã™"
          fi

      - name: AKS è³‡æ ¼æƒ…å ±ã‚’å–å¾—
        run: |
          az aks get-credentials \
            --name "$AKS_CLUSTER_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --overwrite-existing

      - name: Ingress Controller (nginx) ã‚’ç¢ºèª/ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          set -euo pipefail
          # ç›®çš„: ClusterIP ã®ã‚¢ãƒ—ãƒª Service ã‚’å¤–éƒ¨å…¬é–‹ã™ã‚‹ãŸã‚ nginx Ingress Controller ã‚’ Helm ã§å°å…¥ã—ã€LoadBalancer IP ã‚’å–å¾—ã™ã‚‹
          # ãªãœå¿…è¦ã‹: ç¾åœ¨ board-app ã® Service ã¯ ClusterIPã€‚Ingress Controller ãŒå­˜åœ¨ã—ãªã„ã¨å¤–éƒ¨ LB IP ã¯å‰²ã‚Šå½“ã¦ã‚‰ã‚Œãªã„ãŸã‚
          if kubectl get ns ingress-nginx >/dev/null 2>&1; then
            echo "æ—¢ã« ingress-nginx Namespace ãŒå­˜åœ¨ã—ã¾ã™ã€‚å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™";
          else
            echo "ingress-nginx ã‚’ Helm ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™";
            helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
            helm repo update
            # ä½ã‚³ã‚¹ãƒˆ & ã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆ: è¿½åŠ ãƒªã‚½ãƒ¼ã‚¹æœ€å°é™ã€‚Azure LB ã®ãƒ˜ãƒ«ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ–ãƒ‘ã‚¹ã®ã¿æ³¨é‡ˆè¨­å®š
            helm install ingress-nginx ingress-nginx/ingress-nginx \
              --namespace ingress-nginx \
              --create-namespace \
              --set controller.replicaCount=1 \
              --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz
          fi

          echo "LoadBalancer IP ã®å‰²ã‚Šå½“ã¦ã‚’å¾…æ©Ÿã—ã¾ã™ (æœ€å¤§ ~5åˆ†)";
          ATTEMPTS=30
          SLEEP_SEC=10
          for i in $(seq 1 $ATTEMPTS); do
            LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ -n "$LB_IP" ]; then
              echo "âœ… å–å¾—æˆåŠŸ: $LB_IP"
              break
            fi
            echo "[$i/$ATTEMPTS] ã¾ã å‰²ã‚Šå½“ã¦å¾…ã¡..."
            sleep $SLEEP_SEC
          done
          if [ -z "${LB_IP:-}" ]; then
            echo "âš ï¸ è¦å®šæ™‚é–“å†…ã« IP ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§å†åº¦å–å¾—ã‚’è©¦ã¿ã¾ã™";
          fi

      - name: Ingress Controller çŠ¶æ…‹ã‚’è¨˜éŒ²
        if: success()
        run: |
          echo "### ğŸŒ Ingress Controller çŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ingress-nginx >> $GITHUB_STEP_SUMMARY || true
          kubectl get svc -n ingress-nginx >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ACR ç®¡ç†è€…èªè¨¼ã‚’æœ‰åŠ¹åŒ–
        run: |
          az acr update --name "$ACR_NAME" --admin-enabled true

      - name: ACR èªè¨¼æƒ…å ±ã§ Secret ã‚’ä½œæˆ
        run: |
          BOARD_NS=$(grep kubernetesNamespace "${KUSTOMIZE_DIR}/vars.env" | cut -d'=' -f2)
          # namespace ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          kubectl create namespace "$BOARD_NS" --dry-run=client -o yaml | kubectl apply -f -
          # ACR èªè¨¼æƒ…å ±ã‚’å–å¾—
          ACR_USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)
          # Secret ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°
          kubectl create secret docker-registry acr-secret \
            --docker-server="$ACR_LOGIN_SERVER" \
            --docker-username="$ACR_USERNAME" \
            --docker-password="$ACR_PASSWORD" \
            -n "$BOARD_NS" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã«ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ±ºå®š
        id: image_meta
        run: |
          EVENT_NAME='${{ github.event_name }}'
          if [ "$EVENT_NAME" = 'workflow_run' ]; then
            HEAD_SHA='${{ github.event.workflow_run.head_sha }}'
            IMAGE_TAG="${HEAD_SHA:0:12}"
          else
            IMAGE_TAG='${{ github.event.inputs.imageTag }}'
          fi
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG='latest'
          fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> "$GITHUB_ENV"
          echo "IMAGE_FULL=$ACR_LOGIN_SERVER/$BOARD_IMAGE_NAME:$IMAGE_TAG" >> "$GITHUB_ENV"
          echo "BOARD_API_IMAGE_FULL=$ACR_LOGIN_SERVER/$BOARD_API_IMAGE_NAME:$IMAGE_TAG" >> "$GITHUB_ENV"

      - name: DB æ¥ç¶š Secret(board-db-conn) ã‚’ä½œæˆ/æ›´æ–°
        run: |
          set -euo pipefail
          BOARD_NS=$(grep kubernetesNamespace "${KUSTOMIZE_DIR}/vars.env" | cut -d'=' -f2)
          kubectl create namespace "$BOARD_NS" --dry-run=client -o yaml | kubectl apply -f -
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: board-db-conn
            namespace: ${BOARD_NS}
          type: Opaque
          stringData:
            db-endpoint: "${DB_ENDPOINT}"
            db-username: "${DB_APP_USERNAME}"
            db-password: "${DB_APP_PASSWORD}"
          EOF
          echo "board-db-conn Secret ä½œæˆ/æ›´æ–°å®Œäº† (DB_ENDPOINT=${DB_ENDPOINT})"
          echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: DB_APP_PASSWORD ã¯ GitHub Secrets ã¸ã®ç§»è¡Œã‚’æ¨å¥¨ã—ã¾ã™" >> $GITHUB_STEP_SUMMARY

      - name: Kustomize ã‚’é©ç”¨
        run: |
          BOARD_NS=$(grep kubernetesNamespace "${KUSTOMIZE_DIR}/vars.env" | cut -d'=' -f2)
          kubectl kustomize "$KUSTOMIZE_DIR" \
            | sed "s#acr-placeholder.azurecr.io/board-app:latest#${IMAGE_FULL}#g" \
            | sed "s#acr-placeholder.azurecr.io/board-api:latest#${BOARD_API_IMAGE_FULL}#g" \
            | kubectl apply -f -
          kubectl rollout status deployment/board-app -n "$BOARD_NS" --timeout=120s
          kubectl rollout status deployment/board-api -n "$BOARD_NS" --timeout=180s || echo "âš ï¸ board-api ã®ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆç¢ºèªã«å¤±æ•— (å¾Œç¶šã§å†ç¢ºèªå¯èƒ½)"
          kubectl get ingress -n "$BOARD_NS"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒãƒªã‚’å‡ºåŠ›
        if: success()
        run: |
          BOARD_NS=$(grep kubernetesNamespace "${KUSTOMIZE_DIR}/vars.env" | cut -d'=' -f2)
          INGRESS_HOST=$(grep ingressHost "${KUSTOMIZE_DIR}/vars.env" | cut -d'=' -f2)

          # Load Balancer ã® Public IP ã‚’å–å¾—ï¼ˆNGINX Ingress Controller ã®ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ï¼‰
          LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")

          # IP ãŒå–å¾—ã§ããªã„å ´åˆã¯ LoadBalancer Service ã‚’æ¢ã™
          if [ -z "$LB_IP" ]; then
            LB_IP=$(kubectl get svc -A -o json | jq -r '.items[] | select(.spec.type=="LoadBalancer") | .status.loadBalancer.ingress[0].ip' | head -n1 2>/dev/null || echo "")
          fi

          echo "## ğŸ¯ æ²ç¤ºæ¿ã‚¢ãƒ—ãƒª AKS ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **AKS ã‚¯ãƒ©ã‚¹ã‚¿**: \`$AKS_CLUSTER_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: \`$BOARD_NS\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¤ãƒ¡ãƒ¼ã‚¸**: \`$IMAGE_FULL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ“ ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "$LB_IP" ]; then
            echo "- **Load Balancer IP**: \`$LB_IP\`" >> $GITHUB_STEP_SUMMARY
            echo "- **ã‚¢ã‚¯ã‚»ã‚¹URL**: http://$LB_IP" >> $GITHUB_STEP_SUMMARY
            echo "- **ãƒ€ãƒŸãƒ¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**: http://$LB_IP/dummy-secret.txt" >> $GITHUB_STEP_SUMMARY
            # --- ãƒã‚¹ã‚¯å›é¿ç”¨ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ (GitHub Actions ã®è‡ªå‹•ãƒ¬ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–) ---
            # å®Œå…¨ä¸€è‡´æ–‡å­—åˆ—ãŒãƒã‚¹ã‚¯ã•ã‚Œã‚‹å ´åˆã«å‚™ãˆã€IP ã‚’åˆ†å‰²è¡¨ç¤ºã—å†æ§‹ç¯‰æ‰‹æ®µã‚’æç¤ºã™ã‚‹ã€‚
            LB_IP_PARTS=$(echo $LB_IP | tr '.' ' ')
            echo "- **Load Balancer IP(åˆ†å‰²)**: $(echo $LB_IP_PARTS | sed 's/ /./g')" >> $GITHUB_STEP_SUMMARY
            echo "- **å†æ§‹ç¯‰ã‚³ãƒãƒ³ãƒ‰ä¾‹**: \`echo $LB_IP_PARTS | sed 's/ /./g'\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã§ä¸Šè¨˜ IP ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Ingress ãƒ›ã‚¹ãƒˆ**: \`$INGRESS_HOST\`" >> $GITHUB_STEP_SUMMARY
            echo "- **âš ï¸ Load Balancer IP å–å¾—å¤±æ•—**: ã¾ã  IP ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ğŸ’¡ æ•°åˆ†å¾Œã« \`kubectl get svc -A | grep LoadBalancer\` ã§ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ“¦ Pod çŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n "$BOARD_NS" -l app=board-app >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸŒ Ingress çŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n "$BOARD_NS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
