name: 5ï¸âƒ£ Deploy Admin App to Container Apps

on:
  workflow_dispatch:
    inputs:
      imageTag:
        description: "ACR ã«ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿ã® admin-app ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° (ç©ºãªã‚‰ latest)"
        required: false
  workflow_run:
    workflows:
      - "4ï¸âƒ£ Build Admin App"
    types:
      - completed

permissions:
  contents: read
  id-token: write

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  ACA_ENVIRONMENT_NAME: ${{ vars.ACA_ENVIRONMENT_NAME }}
  CONTAINER_APP_NAME: ${{ vars.ADMIN_CONTAINER_APP_NAME }}
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  ADMIN_IMAGE_NAME: admin-app
  ADMIN_TARGET_PORT: 8000
  DB_ENDPOINT: ${{ vars.DB_ENDPOINT }}
  BACKUP_CONTAINER: ${{ vars.BACKUP_CONTAINER_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Azure ã« OIDC ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ACR åã‚’è§£æ±º
        run: |
          set -euo pipefail
          if [ -z "$ACR_NAME_PREFIX" ] || [ -z "$RESOURCE_GROUP_NAME" ]; then
            echo "ACR åã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®å¤‰æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™" >&2
            exit 1
          fi
          ACR_NAME=$(az acr list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" \
            -o tsv)
          if [ -z "$ACR_NAME" ]; then
            echo "æŒ‡å®šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã® ACR ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚infra-deploy ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
            exit 1
          fi
          echo "ACR_NAME=$ACR_NAME" >> "$GITHUB_ENV"
          echo "ACR_LOGIN_SERVER=${ACR_NAME}.azurecr.io" >> "$GITHUB_ENV"

      - name: Container Apps æ‹¡å¼µæ©Ÿèƒ½ã‚’æ›´æ–°
        run: |
          az extension add --name containerapp --upgrade

      - name: ACR ç®¡ç†è€…èªè¨¼ã‚’æœ‰åŠ¹åŒ–
        run: |
          az acr update --name "$ACR_NAME" --admin-enabled true

      - name: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚’æ±ºå®š
        id: image_meta
        run: |
          EVENT_NAME='${{ github.event_name }}'
          if [ "$EVENT_NAME" = 'workflow_run' ]; then
            HEAD_SHA='${{ github.event.workflow_run.head_sha }}'
            IMAGE_TAG="${HEAD_SHA:0:12}"
          else
            IMAGE_TAG='${{ github.event.inputs.imageTag }}'
          fi
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG='latest'
          fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> "$GITHUB_ENV"
          echo "IMAGE_FULL=$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:$IMAGE_TAG" >> "$GITHUB_ENV"

      - name: ACR Pull ç”¨èªè¨¼æƒ…å ±ã‚’å–å¾—
        id: acr_token
        run: |
          ACR_USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)
          echo "ACR_USERNAME=$ACR_USERNAME" >> "$GITHUB_ENV"
          echo "ACR_PASSWORD=$ACR_PASSWORD" >> "$GITHUB_ENV"

      - name: Container Apps ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
        env:
          ADMIN_BASIC_AUTH_USERNAME: ${{ secrets.ADMIN_BASIC_AUTH_USERNAME }}
          ADMIN_BASIC_AUTH_PASSWORD: ${{ secrets.ADMIN_BASIC_AUTH_PASSWORD }}
        run: |
          # Container App ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" &>/dev/null; then
            echo "æ—¢å­˜ã® Container App ã‚’æ›´æ–°ã—ã¾ã™"
            
            # ãƒ¬ã‚¸ã‚¹ãƒˆãƒªèªè¨¼æƒ…å ±ã‚’è¨­å®š
            az containerapp registry set \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --server "$ACR_LOGIN_SERVER" \
              --username "$ACR_USERNAME" \
              --password "$ACR_PASSWORD"
            
            # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æ›´æ–°
            az containerapp secret set \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --secrets admin-username="$ADMIN_BASIC_AUTH_USERNAME" admin-password="$ADMIN_BASIC_AUTH_PASSWORD"
            
            # Container App ã‚’æ›´æ–°
            az containerapp update \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --image "$IMAGE_FULL" \
              --revision-suffix "gh-${GITHUB_RUN_NUMBER}" \
              --set-env-vars \
                ADMIN_USERNAME=secretref:admin-username \
                ADMIN_PASSWORD=secretref:admin-password \
                DB_ENDPOINT="$DB_ENDPOINT" \
                BACKUP_CONTAINER="$BACKUP_CONTAINER"
          else
            echo "æ–°è¦ Container App ã‚’ä½œæˆã—ã¾ã™"
            
            # Container App ã‚’ä½œæˆ
            az containerapp create \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --environment "$ACA_ENVIRONMENT_NAME" \
              --image "$IMAGE_FULL" \
              --ingress external \
              --target-port "$ADMIN_TARGET_PORT" \
              --min-replicas 0 \
              --max-replicas 1 \
              --registry-server "$ACR_LOGIN_SERVER" \
              --registry-username "$ACR_USERNAME" \
              --registry-password "$ACR_PASSWORD" \
              --revision-suffix "gh-${GITHUB_RUN_NUMBER}"
            
            # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®š
            az containerapp secret set \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --secrets admin-username="$ADMIN_BASIC_AUTH_USERNAME" admin-password="$ADMIN_BASIC_AUTH_PASSWORD"
            
            # ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå‚ç…§å«ã‚€ï¼‰
            az containerapp update \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --set-env-vars \
                ADMIN_USERNAME=secretref:admin-username \
                ADMIN_PASSWORD=secretref:admin-password \
                DB_ENDPOINT="$DB_ENDPOINT" \
                BACKUP_CONTAINER="$BACKUP_CONTAINER"
          fi

          # ã‚·ãƒ³ã‚°ãƒ«ãƒªãƒ“ã‚¸ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
          az containerapp revision set-mode \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --mode single

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒžãƒªã‚’å‡ºåŠ›
        if: success()
        run: |
          FQDN=$(az containerapp show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          PROVISIONING_STATE=$(az containerapp show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "properties.provisioningState" -o tsv)
          
          RUNNING_STATUS=$(az containerapp show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "properties.runningStatus" -o tsv)
          
          echo "## ðŸŽ¯ ç®¡ç†ã‚¢ãƒ—ãƒª Container Apps ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Container App å**: \`$CONTAINER_APP_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`$ACA_ENVIRONMENT_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¤ãƒ¡ãƒ¼ã‚¸**: \`$IMAGE_FULL\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Provisioning State**: \`$PROVISIONING_STATE\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Running Status**: \`$RUNNING_STATUS\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **FQDN**: \`$FQDN\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¢ã‚¯ã‚»ã‚¹URL**: https://$FQDN" >> $GITHUB_STEP_SUMMARY
          echo "- **èªè¨¼**: Basic èªè¨¼ (ID/Password å¿…è¦)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âš™ï¸ ç’°å¢ƒå¤‰æ•°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **DB_ENDPOINT**: \`$DB_ENDPOINT\`" >> $GITHUB_STEP_SUMMARY
          echo "- **BACKUP_CONTAINER**: \`$BACKUP_CONTAINER\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ADMIN_USERNAME**: secretref" >> $GITHUB_STEP_SUMMARY
          echo "- **ADMIN_PASSWORD**: secretref" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY

      - name: FQDN ã‚’è¡¨ç¤º
        run: |
          az containerapp show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "properties.configuration.ingress.fqdn"
