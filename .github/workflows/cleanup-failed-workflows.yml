name: ðŸ‘‹cleanup-failed-workflows

on:
    # æ¯Žæ™‚ãƒˆãƒªã‚¬ãƒ¼
    schedule:
        - cron: "0 * * * *"
    # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
    workflow_dispatch:
    # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼
    push:
        paths:
            - ".github/workflows/cleanup-failed-workflows.yml"

permissions:
    contents: read
    actions: write
    # ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰workflow: write

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’ã™ã¹ã¦å‰Šé™¤ï¼ˆstatus=completed âˆ§ conclusion=failureï¼‰
              uses: actions/github-script@v7
              with:
                  script: |
                      const { owner, repo } = context.repo;

                      // 'completed' ã®å®Ÿè¡Œã‚’ãƒšãƒ¼ã‚¸ãƒ³ã‚°å–å¾—
                      const runs = await github.paginate(
                        github.rest.actions.listWorkflowRunsForRepo,
                        { owner, repo, per_page: 100, status: 'completed' },
                        (response) => response.data.workflow_runs || []
                      );

                      let deleted = 0;
                      for (const run of runs) {
                        if (run.conclusion === 'failure') {
                          try {
                            await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                            core.info(`Deleted failed run id=${run.id} name=${run.name} created_at=${run.created_at}`);
                            deleted++;
                          } catch (err) {
                            core.warning(`Failed to delete run id=${run.id}: ${err.message}`);
                          }
                        }
                      }
                      core.info(`Total deleted failed runs: ${deleted}`);

            - name: å¤ã„ Actions ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ä½µã›ã¦å‰Šé™¤ï¼ˆä»»æ„ãƒ»æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰7æ—¥ã‚ˆã‚Šå‰ï¼‰
              uses: actions/github-script@v7
              with:
                  script: |
                      const { owner, repo } = context.repo;
                      const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000; // 7æ—¥å‰

                      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¸€è¦§ï¼ˆactions_cachesï¼‰ã‚’ãƒšãƒ¼ã‚¸ãƒ³ã‚°å–å¾—
                      const caches = await github.paginate(
                        github.rest.actions.getActionsCacheList,
                        { owner, repo, per_page: 100 },
                        (response) => response.data.actions_caches || []
                      );

                      let deleted = 0;
                      for (const cache of caches) {
                        const lastAccessed = new Date(cache.last_accessed_at).getTime();
                        if (Number.isFinite(lastAccessed) && lastAccessed < cutoff) {
                          try {
                            await github.rest.actions.deleteActionsCacheById({ owner, repo, cache_id: cache.id });
                            core.info(`Deleted cache id=${cache.id} key=${cache.key} last_accessed_at=${cache.last_accessed_at}`);
                            deleted++;
                          } catch (err) {
                            core.warning(`Failed to delete cache id=${cache.id}: ${err.message}`);
                          }
                        }
                      }
                      core.info(`Total deleted caches: ${deleted}`);

            - name: å¤ã„ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å‰Šé™¤ï¼ˆä»»æ„ãƒ»ä½œæˆã‹ã‚‰7æ—¥ã‚ˆã‚Šå‰ï¼‰
              uses: actions/github-script@v7
              with:
                  script: |
                      const { owner, repo } = context.repo;
                      const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000; // 7æ—¥å‰

                      const artifacts = await github.paginate(
                        github.rest.actions.listArtifactsForRepo,
                        { owner, repo, per_page: 100 },
                        (response) => response.data.artifacts || []
                      );

                      let deleted = 0;
                      for (const art of artifacts) {
                        const created = new Date(art.created_at).getTime();
                        if (Number.isFinite(created) && created < cutoff) {
                          try {
                            await github.rest.actions.deleteArtifact({ owner, repo, artifact_id: art.id });
                            core.info(`Deleted artifact id=${art.id} name=${art.name} created_at=${art.created_at}`);
                            deleted++;
                          } catch (err) {
                                             core.warning(`Failed to delete artifact id=${art.id}: ${err.message}`);
                          }
                        }
                      }
