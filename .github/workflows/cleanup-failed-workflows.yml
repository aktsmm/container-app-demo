name: cleanup-failed-workflows

on:
    schedule:
        - cron: "15 * * * *"
    workflow_dispatch:

permissions:
    contents: read
    actions: write

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: 失敗したワークフロー実行を削除
              uses: actions/github-script@v7
              with:
                  script: |
                      const cutoff = Date.now() - 24 * 60 * 60 * 1000; // 24 時間前
                      const { owner, repo } = context.repo;
                      const runs = await github.paginate(github.rest.actions.listWorkflowRunsForRepo, {
                        owner,
                        repo,
                        per_page: 100,
                        status: 'completed'
                      });
                      for (const run of runs) {
                        const created = new Date(run.created_at).getTime();
                        if (run.conclusion === 'failure' && created < cutoff) {
                          await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                        }
                      }

            - name: 古い Actions キャッシュを削除
              uses: actions/github-script@v7
              with:
                  script: |
                      const cacheCutoff = Date.now() - 7 * 24 * 60 * 60 * 1000; // 7 日前
                      const { owner, repo } = context.repo;
                      const caches = await github.paginate(github.rest.actions.getActionsCacheList, {
                        owner,
                        repo,
                        per_page: 100
                      });
                      for (const cache of caches) {
                        const lastAccessed = new Date(cache.last_accessed_at).getTime();
                        if (lastAccessed < cacheCutoff) {
                          await github.rest.actions.deleteActionsCacheById({ owner, repo, cache_id: cache.id });
                        }
                      }
