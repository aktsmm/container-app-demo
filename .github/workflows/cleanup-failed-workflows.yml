name: ğŸ§¹ Cleanup Workflow Runs (Keep latest 7 human + 3 dependabot + 1 failed)

on:
    schedule:
        - cron: "0 */12 * * *" # 12æ™‚é–“ã”ã¨
    workflow_dispatch:
    #  workflow_run:
    #    workflows:
    #     - "1. Deploy Infrastructure"
    #    - "2-1. Build and Deploy Application"
    #   - "2-2. Deploy Policy Guardrails"
    #types: [completed]
    push:
        branches: [main]
        paths:
            - ".github/workflows/cleanup.yml"
            - ".github/workflows/ğŸ§¹*.yml"

permissions:
    actions: write
    contents: read

jobs:
    cleanup:
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: ğŸ§¹ Cleanup all old workflow runs
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  REPO="${{ github.repository }}"
                  # GitHub å´ã§ä»˜ä¸ã•ã‚Œã‚‹å®Ÿè¡Œåã‚’å„ªå…ˆã—ã€åç§°å¤‰æ›´æ™‚ã‚‚å¸¸ã«ä¸€è‡´ã•ã›ã‚‹
                  SELF_NAME="${GITHUB_WORKFLOW:-ğŸ§¹ Cleanup Workflow Runs (Keep latest 7 human + 3 dependabot + 1 failed)}"

                  echo "ğŸ” Getting all Cleanup workflow runs..."
                  RUNS=$(gh run list --workflow "$SELF_NAME" --json databaseId,headBranch,status,conclusion,createdAt --limit 1000)
                  COUNT=$(echo "$RUNS" | jq 'length')
                  echo "ğŸ§¾ Found $COUNT Cleanup runs total."

                  # ç¾åœ¨ã® Cleanup å®Ÿè¡Œä¸­ã® ID ã‚’å–å¾—
                  CURRENT_ID=$(echo "$RUNS" | jq -r '.[] | select(.status=="in_progress" or .status=="queued") | .databaseId' | head -n 1)
                  echo "ğŸŸ¢ Current Cleanup Run ID: ${CURRENT_ID:-none}"

                  # ç¾è¡ŒRunä»¥å¤–ã‚’å‰Šé™¤å¯¾è±¡ã¨ã™ã‚‹
                  TARGETS=$(echo "$RUNS" | jq -r --arg cur "$CURRENT_ID" '.[] | select(.databaseId != ($cur|tonumber)) | .databaseId')

                  if [ -z "$TARGETS" ]; then
                    echo "âœ… No old Cleanup runs to delete."
                  else
                    echo "$TARGETS" | while read -r ID; do
                      echo "ğŸ§¹ Deleting old Cleanup run ID: $ID"
                      gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "âš ï¸ Failed to delete run $ID"
                    done
                  fi

                  echo "ğŸ§© Cleaning other workflows (7 human + 3 dependabot + 1 failed)..."
                  ALL_RUNS=$(gh api repos/$REPO/actions/runs --paginate -q '.workflow_runs[] | {id: .id, name: .name, conclusion: .conclusion, created_at: .created_at, actor: (.actor.login // "unknown")}' | jq -s 'sort_by(.created_at) | reverse')

                  # âœ… æˆåŠŸã—ãŸ human å®Ÿè¡Œ: æœ€æ–°7ä»¶ä¿æŒ
                  KEEP_HUMAN=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.actor != "dependabot[bot]" and .conclusion == "success")][:10] | map(.id)')

                  # âœ… æˆåŠŸã—ãŸ dependabot å®Ÿè¡Œ: æœ€æ–°3ä»¶ä¿æŒ
                  KEEP_DEPENDABOT=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.actor == "dependabot[bot]" and .conclusion == "success")][:5] | map(.id)')

                  # âœ… å¤±æ•—ã—ãŸå®Ÿè¡Œ: æœ€æ–°1ä»¶ä¿æŒ
                  KEEP_FAILED=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.conclusion != "success")][:1] | map(.id)')

                  # âœ… ä¿æŒå¯¾è±¡ã‚’çµ±åˆ
                  KEEP_ALL=$(jq -n --argjson a "$KEEP_HUMAN" --argjson b "$KEEP_DEPENDABOT" --argjson c "$KEEP_FAILED" '$a + $b + $c')

                  # ğŸ§¹ å‰Šé™¤å¯¾è±¡ã‚’æŠ½å‡º
                  TARGETS=$(echo "$ALL_RUNS" | jq -c --argjson keepIds "$KEEP_ALL" '[ .[] | select((.id as $id | ($keepIds | index($id)) | not)) ]')
                  COUNT=$(echo "$TARGETS" | jq 'length')
                  echo "ğŸ§¹ Found $COUNT runs to delete."

                  # ğŸš® å‰Šé™¤å‡¦ç†
                  if (( COUNT > 0 )); then
                    echo "$TARGETS" | jq -c '.[]' | while read -r run; do
                      ID=$(echo "$run" | jq -r '.id')
                      NAME=$(echo "$run" | jq -r '.name')
                      CONCLUSION=$(echo "$run" | jq -r '.conclusion')
                      echo "ğŸ—‘ï¸ Deleting run $ID [$NAME] ($CONCLUSION)"
                      gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "âš ï¸ Failed to delete run $ID"
                    done
                  else
                    echo "âœ… No old workflow runs to delete."
                  fi

                  echo "ğŸ‰ Cleanup complete (kept 1 current + 7 human + 3 dependabot + 1 failed)."

# Docs_work_history ã«ã‚‚åæ˜ ã€‚
# infra-deploy ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤‰æ•°ãŒæœ€æ–°åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹å†ç¢ºèªã—ã€workflow_dispatch ã§å‹•ä½œã‚’æ¤œè¨¼ã€‚
