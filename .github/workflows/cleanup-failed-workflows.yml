name: üßπ Cleanup Workflow Runs (Keep latest 7 human + 3 dependabot + 1 failed)

on:
    schedule:
        - cron: "0 */12 * * *" # 12ÊôÇÈñì„Åî„Å®
    workflow_dispatch:
    push:
        branches: [main]
        paths:
            - ".github/workflows/cleanup.yml"
            - ".github/workflows/üßπ*.yml"

permissions:
    actions: write
    contents: read

jobs:
    cleanup:
        # ÊâãÂãï„Å®„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅØÂ∏∏„Å´ÂÆüË°å„ÄÅpush „ÅÆ„Åø main „Å´ÈôêÂÆöÔºà„Çπ„Ç≠„ÉÉ„ÉóÈò≤Ê≠¢Ôºâ
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        runs-on: ubuntu-latest

        steps:
            - name: Debug context (for skip investigation)
              run: |
                  echo "event_name=${{ github.event_name }}"
                  echo "ref=${{ github.ref }}"
                  echo "workflow=${{ github.workflow }}"
                  echo "actor=${{ github.actor }}"
                  echo "repository=${{ github.repository }}"

            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Select token (prefer PAT if available)
              id: tok
              run: |
                  if [ -n "${{ secrets.GH_PAT_ACTIONS_DELETE }}" ]; then
                    echo "token=${{ secrets.GH_PAT_ACTIONS_DELETE }}" >> $GITHUB_OUTPUT
                    echo "Using PAT: GH_PAT_ACTIONS_DELETE"
                  else
                    echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
                    echo "Using GITHUB_TOKEN (no PAT provided)"
                  fi

            - name: Auth gh cli
              env:
                  GH_TOKEN: ${{ steps.tok.outputs.token }}
              run: |
                  gh auth status || gh auth login --with-token <<< "$GH_TOKEN"

            - name: üßπ Cleanup old runs of this workflow (exclude current)
              env:
                  GH_TOKEN: ${{ steps.tok.outputs.token }}
              run: |
                  set -euo pipefail
                  REPO="${{ github.repository }}"
                  SELF_NAME="${GITHUB_WORKFLOW}"

                  echo "üîç Getting all runs for workflow: $SELF_NAME"
                  RUNS=$(gh run list --workflow "$SELF_NAME" --json databaseId,status --limit 1000)
                  CURRENT_ID=$(echo "$RUNS" | jq -r '.[] | select(.status=="in_progress" or .status=="queued") | .databaseId' | head -n 1)

                  TARGETS=$(echo "$RUNS" | jq -r --arg cur "$CURRENT_ID" '.[] | select(.databaseId != ($cur|tonumber)) | .databaseId')
                  if [ -n "$TARGETS" ]; then
                    echo "$TARGETS" | while read -r ID; do
                      echo "üßπ Deleting old Cleanup run ID: $ID"
                      gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "‚ö†Ô∏è Failed to delete run $ID"
                      sleep 0.3
                    done
                  else
                    echo "‚úÖ No old Cleanup runs to delete."
                  fi

            - name: üß© Clean other workflow runs (keep 7 human + 3 dependabot + 1 failed)
              env:
                  GH_TOKEN: ${{ steps.tok.outputs.token }}
              run: |
                  set -euo pipefail
                  REPO="${{ github.repository }}"

                  echo "üîç Listing all workflow runs (paginated)..."
                  ALL_RUNS=$(gh api repos/$REPO/actions/runs --paginate \
                    -q '.workflow_runs[] | {id: .id, name: .name, conclusion: .conclusion, created_at: .created_at, actor: (.actor.login // "unknown")}' \
                    | jq -s 'sort_by(.created_at) | reverse')

                  # ‚úÖ ÊàêÂäü„Åó„Åü human: ÊúÄÊñ∞7‰ª∂‰øùÊåÅ
                  KEEP_HUMAN=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.actor != "dependabot[bot]" and .conclusion == "success")][:7] | map(.id)')
                  # ‚úÖ ÊàêÂäü„Åó„Åü dependabot: ÊúÄÊñ∞3‰ª∂‰øùÊåÅ
                  KEEP_DEPENDABOT=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.actor == "dependabot[bot]" and .conclusion == "success")][:3] | map(.id)')
                  # ‚úÖ Â§±ÊïóÔºàÈùûsuccessÔºâ: ÊúÄÊñ∞1‰ª∂‰øùÊåÅ
                  KEEP_FAILED=$(echo "$ALL_RUNS" | jq -c '[.[] | select(.conclusion != "success")][:1] | map(.id)')

                  KEEP_ALL=$(jq -n --argjson a "$KEEP_HUMAN" --argjson b "$KEEP_DEPENDABOT" --argjson c "$KEEP_FAILED" '$a + $b + $c')

                  TARGETS=$(echo "$ALL_RUNS" | jq -c --argjson keepIds "$KEEP_ALL" '[ .[] | select((.id as $id | ($keepIds | index($id)) | not)) ]')
                  COUNT=$(echo "$TARGETS" | jq 'length')
                  echo "üßπ Found $COUNT runs to delete."

                  if (( COUNT > 0 )); then
                    echo "$TARGETS" | jq -c '.[]' | while read -r run; do
                      ID=$(echo "$run" | jq -r '.id')
                      NAME=$(echo "$run" | jq -r '.name')
                      CONCLUSION=$(echo "$run" | jq -r '.conclusion')
                      echo "üóëÔ∏è Deleting run $ID [$NAME] ($CONCLUSION)"
                      gh api repos/$REPO/actions/runs/$ID -X DELETE || echo "‚ö†Ô∏è Failed to delete run $ID"
                      sleep 0.3
                    done
                  else
                    echo "‚úÖ No old workflow runs to delete."
                  fi

                  echo "üéâ Cleanup complete (kept current + 7 human + 3 dependabot + 1 failed runs)"
