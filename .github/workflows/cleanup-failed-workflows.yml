name: cleanup-failed-workflows

on:
    # 毎時 0 分に実行
    schedule:
        - cron: "0 * * * *"
    # 手動トリガー
    workflow_dispatch:
    # このファイルが更新されたときにトリガー
    push:
        paths:
            - ".github/workflows/cleanup-failed-workflows.yml"

permissions:
    contents: read
    actions: write
    # （必要に応じて）workflow: write

jobs:
    cleanup:
        runs-on: ubuntu-latest
        steps:
            - name: 失敗したワークフロー実行を全削除（PAT使用・全Workflow横断）
              uses: actions/github-script@v7
              with:
                  # 重要：GITHUB_TOKEN では権限不足の可能性があるため Fine-grained PAT を使用
                  github-token: ${{ secrets.GH_PAT_ACTIONS_DELETE }}
                  script: |
                      const { owner, repo } = context.repo;

                      // 全Workflowを取得
                      const workflows = await github.paginate(
                        github.rest.actions.listRepoWorkflows,
                        { owner, repo, per_page: 100 },
                        (resp) => resp.data.workflows || []
                      );

                      let totalDeleted = 0;
                      const sleep = (ms) => new Promise(r => setTimeout(r, ms));

                      // 削除対象の結論（必要に応じて増やす）
                      const DELETE_CONCLUSIONS = ['failure']; // 'cancelled','timed_out' を含めたい場合は追加

                      for (const wf of workflows) {
                        core.info(`Processing workflow: ${wf.name} (id=${wf.id})`);

                        // 該当Workflowの completed 実行をページング取得
                        const runs = await github.paginate(
                          github.rest.actions.listWorkflowRuns,
                          { owner, repo, workflow_id: wf.id, status: 'completed', per_page: 100 },
                          (resp) => resp.data.workflow_runs || []
                        );

                        for (const run of runs) {
                          if (DELETE_CONCLUSIONS.includes(run.conclusion)) {
                            try {
                              await github.rest.actions.deleteWorkflowRun({ owner, repo, run_id: run.id });
                              core.info(`Deleted run id=${run.id} name=${run.name} conclusion=${run.conclusion} created_at=${run.created_at}`);
                              totalDeleted++;
                              await sleep(300); // 軽いバックオフ（大量削除対策）
                            } catch (err) {
                              core.warning(`Failed to delete run id=${run.id}: ${err.status} ${err.message}`);
                              await sleep(1500); // レート制限対策
                            }
                          }
                        }
                      }

                      core.info(`Total deleted runs: ${totalDeleted}`);

            - name: （任意）古いアーティファクト・キャッシュも整理
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GH_PAT_ACTIONS_DELETE }}
                  script: |
                      const { owner, repo } = context.repo;
                      const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000; // 7日前
                      const sleep = (ms) => new Promise(r => setTimeout(r, ms));

                      // アーティファクト
                      const artifacts = await github.paginate(
                        github.rest.actions.listArtifactsForRepo,
                        { owner, repo, per_page: 100 },
                        (resp) => resp.data.artifacts || []
                      );

                      let artifactsDeleted = 0;
                      for (const art of artifacts) {
                        const created = new Date(art.created_at).getTime();
                        if (Number.isFinite(created) && created < cutoff) {
                          try {
                            await github.rest.actions.deleteArtifact({ owner, repo, artifact_id: art.id });
                            core.info(`Deleted artifact id=${art.id} name=${art.name}`);
                            artifactsDeleted++;
                            await sleep(300);
                          } catch (err) {
                            core.warning(`Failed to delete artifact id=${art.id}: ${err.status} ${err.message}`);
                            await sleep(1500);
                          }
                        }
                      }

                      // キャッシュ（actions_caches）
                      const caches = await github.paginate(
                        github.rest.actions.getActionsCacheList,
                        { owner, repo, per_page: 100 },
                        (resp) => resp.data.actions_caches || []
                      );

                      let cachesDeleted = 0;
                      for (const cache of caches) {
                        const lastAccessed = new Date(cache.last_accessed_at).getTime();
                        if (Number.isFinite(lastAccessed) && lastAccessed < cutoff) {
                          try {
                            await github.rest.actions.deleteActionsCacheById({ owner, repo, cache_id: cache.id });
                            core.info(`Deleted cache id=${cache.id} key=${cache.key}`);
                            cachesDeleted++;
                            await sleep(300);
                          } catch (err) {
                            core.warning(`Failed to delete cache id=${cache.id}: ${err.status} ${err.message}`);
                            await sleep(1500);
                          }
                                     }
                      }
