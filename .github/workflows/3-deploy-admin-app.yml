name: 3ï¸âƒ£ Deploy Admin App (Container Apps)

on:
  workflow_dispatch:
    inputs:
      imageTag:
        description: "ACR ã«ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿ã® admin-app ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚° (ç©ºãªã‚‰ latest)"
        required: false
  workflow_run:
    workflows:
      - "2ï¸âƒ£ Build Admin App"
    types:
      - completed

permissions:
  contents: read
  id-token: write
  actions: read # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ workflow ãƒªã‚¹ãƒˆå–å¾—ã«å¿…è¦

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  ACA_ENVIRONMENT_NAME: ${{ vars.ACA_ENVIRONMENT_NAME }}
  CONTAINER_APP_NAME: ${{ vars.ADMIN_CONTAINER_APP_NAME }}
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  STORAGE_ACCOUNT_PREFIX: ${{ vars.STORAGE_ACCOUNT_PREFIX }}
  ADMIN_IMAGE_NAME: admin-app
  ADMIN_TARGET_PORT: 8000
  BACKUP_CONTAINER: ${{ vars.BACKUP_CONTAINER_NAME }}
  DB_APP_USERNAME: ${{ vars.DB_APP_USERNAME }}
  DB_APP_PASSWORD: ${{ vars.DB_APP_PASSWORD }}
  ACA_ADMIN_USERNAME: ${{ vars.ACA_ADMIN_USERNAME }}
  ACA_ADMIN_PASSWORD: ${{ vars.ACA_ADMIN_PASSWORD }}

jobs:
  prepare-container-app:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      acr_name: ${{ steps.resolve_acr.outputs.acr_name }}
      acr_login_server: ${{ steps.resolve_acr.outputs.acr_login_server }}
      storage_account_name: ${{ steps.resolve_storage.outputs.storage_account_name }}
      db_endpoint: ${{ steps.mysql_endpoint.outputs.db_endpoint }}
      aca_environment_name: ${{ steps.resolve_env.outputs.aca_environment_name }}
      image_tag: ${{ steps.image_meta.outputs.image_tag }}
      image_full: ${{ steps.image_meta.outputs.image_full }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ACR åã‚’è§£æ±º
        id: resolve_acr
        run: |
          set -euo pipefail
          if [ -z "$ACR_NAME_PREFIX" ] || [ -z "$RESOURCE_GROUP_NAME" ]; then
            echo "ACR åã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®å¤‰æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™" >&2
            exit 1
          fi
          ACR_NAME=$(az acr list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" \
            -o tsv)
          if [ -z "$ACR_NAME" ]; then
            echo "æŒ‡å®šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã® ACR ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚infra-deploy ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
            exit 1
          fi
          echo "acr_name=$ACR_NAME" >> "$GITHUB_OUTPUT"
          echo "acr_login_server=${ACR_NAME}.azurecr.io" >> "$GITHUB_OUTPUT"

      - name: Storage Account åã‚’è§£æ±º
        id: resolve_storage
        run: |
          set -euo pipefail
          STORAGE_NAME=$(az storage account list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[?starts_with(name, '${STORAGE_ACCOUNT_PREFIX}')].name | [0]" \
            -o tsv)
          if [ -z "$STORAGE_NAME" ]; then
            echo "æŒ‡å®šãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã® Storage Account ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
            exit 1
          fi
          echo "storage_account_name=$STORAGE_NAME" >> "$GITHUB_OUTPUT"

      - name: ã‚¤ãƒ³ãƒ•ãƒ©å‡ºåŠ›ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ MySQL IP ã‚’å–å¾—
        id: mysql_endpoint
        env:
          GH_TOKEN: ${{ github.token }}
          INFRA_WORKFLOW_NAME: "1ï¸âƒ£ Infrastructure Deploy"
        run: |
          set -euo pipefail
          mkdir -p infra-output
          if [ "${{ github.event_name }}" = "workflow_run" ] && [ "${{ github.event.workflow_run.name }}" = "$INFRA_WORKFLOW_NAME" ]; then
            TARGET_RUN_ID='${{ github.event.workflow_run.id }}'
            echo "workflow_run ãƒˆãƒªã‚¬ãƒ¼: run_id=$TARGET_RUN_ID"
          else
            TARGET_RUN_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/1-infra-deploy.yml/runs?status=success&per_page=1" \
              | jq -r '.workflow_runs[0].id')
            echo "æ‰‹å‹•å®Ÿè¡Œ: æœ€æ–°ã®æˆåŠŸã—ãŸ Infrastructure Deploy run_id=$TARGET_RUN_ID"
          fi
          if [ -z "$TARGET_RUN_ID" ] || [ "$TARGET_RUN_ID" = "null" ]; then
            echo "ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Ÿè¡Œå±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >&2
            exit 1
          fi
          gh run download "$TARGET_RUN_ID" --name infra-outputs --dir infra-output >/dev/null
          OUTPUT_FILE=$(find infra-output -name '*.json' | head -n1)
          if [ -z "$OUTPUT_FILE" ]; then
            echo "infra-outputs ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã« JSON ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“" >&2
            exit 1
          fi
          MYSQL_IP=$(jq -r '.mysqlPrivateIp.value' "$OUTPUT_FILE")
          if [ -z "$MYSQL_IP" ] || [ "$MYSQL_IP" = "null" ]; then
            echo "infra å‡ºåŠ›ã« mysqlPrivateIp ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
            exit 1
          fi
          echo "db_endpoint=${MYSQL_IP}:3306" >> "$GITHUB_OUTPUT"
          echo "Resolved MySQL endpoint: ${MYSQL_IP}:3306"

      - name: Container Apps Environment åã‚’å‹•çš„è§£æ±º
        id: resolve_env
        run: |
          set -euo pipefail
          ACTUAL_ENV_NAME=$(az containerapp env list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[0].name" \
            -o tsv)
          if [ -z "$ACTUAL_ENV_NAME" ]; then
            echo "Container Apps Environment ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚infra-deploy ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
            exit 1
          fi
          echo "æ¤œå‡ºã•ã‚ŒãŸ Environment: $ACTUAL_ENV_NAME"
          echo "aca_environment_name=$ACTUAL_ENV_NAME" >> "$GITHUB_OUTPUT"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã«ä½¿ç”¨ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚’æ±ºå®š
        id: image_meta
        env:
          INPUT_TAG: ${{ github.event.inputs.imageTag }}
        run: |
          set -euo pipefail
          validate_tag() {
            local candidate="$1"
            if [[ "$candidate" =~ ^[A-Za-z0-9][A-Za-z0-9._-]{0,127}$ ]]; then
              return 0
            fi
            return 1
          }

          pick_latest_tag() {
            local registry_name="${{ steps.resolve_acr.outputs.acr_name }}"
            local raw_tags
            raw_tags=$(az acr repository show-tags \
              --name "$registry_name" \
              --repository "$ADMIN_IMAGE_NAME" \
              --orderby time_desc \
              --top 50 \
              -o tsv || true)
            if [ -z "$raw_tags" ]; then
              echo ""
              return
            fi
            while IFS= read -r tag; do
              [ -z "$tag" ] && continue
              if [ "$tag" = "latest" ]; then
                continue
              fi
              if validate_tag "$tag"; then
                echo "$tag"
                return
              else
                echo "âš ï¸ ACR ã‚¿ã‚° '$tag' ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚¿ã‚°å½¢å¼ã«åˆè‡´ã—ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—" >&2
              fi
            done <<< "$raw_tags"
          }

          TARGET_TAG=""
          if [ -n "$INPUT_TAG" ]; then
            echo "æ‰‹å‹•å…¥åŠ›ã‚¿ã‚°ã‚’æ¤œè¨¼ã—ã¾ã™: $INPUT_TAG"
            if validate_tag "$INPUT_TAG"; then
              TARGET_TAG="$INPUT_TAG"
            else
              echo "âŒ å…¥åŠ›ã‚¿ã‚° '$INPUT_TAG' ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚¿ã‚°è¦å‰‡ã«é•åã—ã¦ã„ã¾ã™ (è‹±æ•°å­—/._- ã®ã¿ä½¿ç”¨å¯)" >&2
              exit 1
            fi
          else
            echo "ACR ã‹ã‚‰æœ€æ–°ã®æœ‰åŠ¹ã‚¿ã‚°ã‚’æŽ¢ç´¢ã—ã¾ã™ (latest ã¯é™¤å¤–)"
            TARGET_TAG=$(pick_latest_tag)
            if [ -z "$TARGET_TAG" ]; then
              echo "âš ï¸ æœ‰åŠ¹ãªã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŸã‚ latest ã‚’ä½¿ç”¨ã—ã¾ã™"
              TARGET_TAG="latest"
            else
              echo "ACR ã§æ¤œå‡ºã—ãŸã‚¿ã‚°: $TARGET_TAG"
            fi
          fi

          IMAGE_FULL="${{ steps.resolve_acr.outputs.acr_login_server }}/$ADMIN_IMAGE_NAME:$TARGET_TAG"
          echo "image_tag=$TARGET_TAG" >> "$GITHUB_OUTPUT"
          echo "image_full=$IMAGE_FULL" >> "$GITHUB_OUTPUT"

  aca-setup:
    runs-on: ubuntu-latest
    needs: prepare-container-app
    if: ${{ needs.prepare-container-app.result == 'success' }}
    env:
      ACA_ENVIRONMENT_NAME: ${{ needs.prepare-container-app.outputs.aca_environment_name }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: Container Apps æ‹¡å¼µæ©Ÿèƒ½ã‚’æ›´æ–°
        run: |
          az extension add --name containerapp --upgrade

      - name: Container Apps Environment ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å®Œäº†ã‚’å¾…æ©Ÿ
        run: |
          set -euo pipefail
          MAX_RETRY=20
          INTERVAL=30
          for attempt in $(seq 1 $MAX_RETRY); do
            STATE=$(az containerapp env show \
              --name "$ACA_ENVIRONMENT_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --query "properties.provisioningState" -o tsv || echo "Unknown")
            if [ "$STATE" = "Succeeded" ]; then
              echo "Container Apps Environment ã¯æ­£å¸¸ã«ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æ¸ˆã¿ã§ã™"
              exit 0
            fi
            echo "[å¾…æ©Ÿ] çŠ¶æ…‹: $STATE (è©¦è¡Œ $attempt/$MAX_RETRY)"
            sleep $INTERVAL
          done
          echo "Container Apps Environment ãŒè¦å®šæ™‚é–“å†…ã« Succeeded ã«ãªã‚Šã¾ã›ã‚“ã§ã—ãŸ" >&2
          exit 1

  revision-deploy:
    runs-on: ubuntu-latest
    needs: [prepare-container-app, aca-setup]
    if: ${{ needs.aca-setup.result == 'success' }}
    env:
      ACR_NAME: ${{ needs.prepare-container-app.outputs.acr_name }}
      ACR_LOGIN_SERVER: ${{ needs.prepare-container-app.outputs.acr_login_server }}
      IMAGE_TAG: ${{ needs.prepare-container-app.outputs.image_tag }}
      IMAGE_FULL: ${{ needs.prepare-container-app.outputs.image_full }}
      DB_ENDPOINT_RESOLVED: ${{ needs.prepare-container-app.outputs.db_endpoint }}
      STORAGE_ACCOUNT_NAME: ${{ needs.prepare-container-app.outputs.storage_account_name }}
      ACA_ENVIRONMENT_NAME: ${{ needs.prepare-container-app.outputs.aca_environment_name }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ACR ç®¡ç†è€…èªè¨¼ã‚’æœ‰åŠ¹åŒ–
        run: |
          az acr update --name "$ACR_NAME" --admin-enabled true

      - name: ACR Pull ç”¨èªè¨¼æƒ…å ±ã‚’å–å¾—
        run: |
          ACR_USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)
          echo "ACR_USERNAME=$ACR_USERNAME" >> "$GITHUB_ENV"
          echo "ACR_PASSWORD=$ACR_PASSWORD" >> "$GITHUB_ENV"

      - name: Container Apps ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          if az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" &>/dev/null; then
            echo "æ—¢å­˜ã® Container App ã‚’æ›´æ–°ã—ã¾ã™"
            az containerapp registry set \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --server "$ACR_LOGIN_SERVER" \
              --username "$ACR_USERNAME" \
              --password "$ACR_PASSWORD"
            az containerapp secret set \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --secrets admin-username="$ACA_ADMIN_USERNAME" admin-password="$ACA_ADMIN_PASSWORD"
            az containerapp update \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --image "$IMAGE_FULL" \
              --revision-suffix "gh-${GITHUB_RUN_NUMBER}" \
              --set-env-vars \
                ADMIN_USERNAME=secretref:admin-username \
                ADMIN_PASSWORD=secretref:admin-password \
                DB_ENDPOINT="$DB_ENDPOINT_RESOLVED" \
                DB_APP_USERNAME="$DB_APP_USERNAME" \
                DB_APP_PASSWORD="$DB_APP_PASSWORD" \
                DB_NAME="boardapp" \
                BACKUP_CONTAINER="$BACKUP_CONTAINER" \
                STORAGE_ACCOUNT_NAME="$STORAGE_ACCOUNT_NAME"
          else
            echo "æ–°è¦ Container App ã‚’ä½œæˆã—ã¾ã™"
            az containerapp create \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --environment "$ACA_ENVIRONMENT_NAME" \
              --image "$IMAGE_FULL" \
              --ingress external \
              --target-port "$ADMIN_TARGET_PORT" \
              --min-replicas 0 \
              --max-replicas 1 \
              --registry-server "$ACR_LOGIN_SERVER" \
              --registry-username "$ACR_USERNAME" \
              --registry-password "$ACR_PASSWORD" \
              --revision-suffix "gh-${GITHUB_RUN_NUMBER}"
            az containerapp secret set \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --secrets admin-username="$ACA_ADMIN_USERNAME" admin-password="$ACA_ADMIN_PASSWORD"
            az containerapp update \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --set-env-vars \
                ADMIN_USERNAME=secretref:admin-username \
                ADMIN_PASSWORD=secretref:admin-password \
                DB_ENDPOINT="$DB_ENDPOINT_RESOLVED" \
                DB_APP_USERNAME="$DB_APP_USERNAME" \
                DB_APP_PASSWORD="$DB_APP_PASSWORD" \
                DB_NAME="boardapp" \
                BACKUP_CONTAINER="$BACKUP_CONTAINER" \
                STORAGE_ACCOUNT_NAME="$STORAGE_ACCOUNT_NAME"
          fi
          az containerapp revision set-mode \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --mode single

      - name: Container App ã« Managed Identity ã‚’ä»˜ä¸Ž
        run: |
          set -euo pipefail
          echo "Container App ã« System Assigned Managed Identity ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™"
          az containerapp identity assign \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --system-assigned
          PRINCIPAL_ID=$(az containerapp identity show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query principalId -o tsv)
          echo "Managed Identity Principal ID: $PRINCIPAL_ID"

          # az ad ã‚³ãƒžãƒ³ãƒ‰ã§ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª
          MAX_MI_WAIT=20
          SLEEP_SECONDS=15
          echo "Managed Identity ã® AAD ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ€å¤§ $((MAX_MI_WAIT * SLEEP_SECONDS)) ç§’å¾…æ©Ÿã—ã¾ã™"
          for attempt in $(seq 1 $MAX_MI_WAIT); do
            # az ad sp show ã§ Service Principal ã®å­˜åœ¨ç¢ºèª
            SP_EXISTS=$(az ad sp show --id "$PRINCIPAL_ID" --query "id" -o tsv 2>/dev/null || echo "")
            
            if [ -n "$SP_EXISTS" ]; then
              echo "âœ“ Managed Identity available (è©¦è¡Œ $attempt/$MAX_MI_WAIT)"
              break
            fi
            
            if [ "$attempt" -eq "$MAX_MI_WAIT" ]; then
              echo "âš ï¸ Managed Identity ãŒæŒ‡å®šæ™‚é–“å†…ã«å‚ç…§å¯èƒ½ã«ãªã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ã¯ç¶™ç¶šè©¦è¡Œï¼‰" >&2
              echo "PRINCIPAL_ID=$PRINCIPAL_ID ã§ AAD ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœªå®Œäº†ã§ã™" >&2
              # è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã«ã›ãšã€ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ã‚’è©¦è¡Œã•ã›ã‚‹ï¼ˆAAD ä¼æ¬é…å»¶ã‚’è¨±å®¹ï¼‰
              echo "MI_REPLICATION_DELAYED=true" >> "$GITHUB_ENV"
              break
            fi
            echo "[MIå¾…æ©Ÿ] ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸­â€¦ (è©¦è¡Œ $attempt/$MAX_MI_WAIT)"
            sleep $SLEEP_SECONDS
          done

          # ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ç¢ºèªï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          echo ""
          echo "ðŸ“‹ Managed Identity ã®ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ã‚’ç¢ºèªã—ã¾ã™ï¼ˆæœ€å¤§ 5 å›žè©¦è¡Œï¼‰"
          MAX_ROLE_CHECK=5
          ROLE_SLEEP=10
          for role_attempt in $(seq 1 $MAX_ROLE_CHECK); do
            ROLE_LIST=$(az role assignment list \
              --assignee "$PRINCIPAL_ID" \
              --include-inherited \
              --all \
              -o table 2>/dev/null || echo "")
            
            if [ -n "$ROLE_LIST" ]; then
              echo "$ROLE_LIST"
              echo "âœ“ ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ä¸€è¦§ã‚’å–å¾—ã—ã¾ã—ãŸ (è©¦è¡Œ $role_attempt/$MAX_ROLE_CHECK)"
              break
            fi
            
            if [ "$role_attempt" -eq "$MAX_ROLE_CHECK" ]; then
              echo "âš ï¸ ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã¾ã æœªå‰²ã‚Šå½“ã¦ã€ã¾ãŸã¯ AAD ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶ï¼‰"
              break
            fi
            echo "[ãƒ­ãƒ¼ãƒ«ç¢ºèª] å–å¾—ä¸­â€¦ (è©¦è¡Œ $role_attempt/$MAX_ROLE_CHECK)"
            sleep $ROLE_SLEEP
          done
          echo "âš ï¸ ã€ãƒ‡ãƒ¢ç”¨ã€‘Subscription ã‚¹ã‚³ãƒ¼ãƒ—ã§ Contributor ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸Žã—ã¾ã™ï¼ˆéŽå‰°ãªæ¨©é™ï¼‰"
          ROLE_RETRY_WAIT_SECONDS=180
          echo "ãƒ­ãƒ¼ãƒ«ä»˜ä¸ŽãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿ ${ROLE_RETRY_WAIT_SECONDS} ç§’å¾…ã£ã¦å†è©¦è¡Œã—ã¾ã™"
          if ! az role assignment create \
            --assignee-object-id "$PRINCIPAL_ID" \
            --assignee-principal-type ServicePrincipal \
            --role "Contributor" \
            --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}"; then
              echo "âš ï¸ åˆå›žãƒ­ãƒ¼ãƒ«ä»˜ä¸Žã«å¤±æ•—ã—ã¾ã—ãŸã€‚AAD ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¾…æ©Ÿã®ãŸã‚ ${ROLE_RETRY_WAIT_SECONDS} ç§’ã‚¹ãƒªãƒ¼ãƒ—" >&2
              sleep $ROLE_RETRY_WAIT_SECONDS
              az role assignment create \
                --assignee-object-id "$PRINCIPAL_ID" \
                --assignee-principal-type ServicePrincipal \
                --role "Contributor" \
                --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}" || {
                  echo "âŒ ãƒ­ãƒ¼ãƒ«ä»˜ä¸ŽãŒç¹°ã‚Šè¿”ã—å¤±æ•—ã—ã¾ã—ãŸ" >&2
                  exit 1
                }
          fi
          STORAGE_ID=$(az storage account show \
            --name "$STORAGE_ACCOUNT_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query id -o tsv)
          echo "Storage Account ã«å¯¾ã—ã¦ Storage Blob Data Contributor ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸Žã—ã¾ã™ï¼ˆå¤±æ•—æ™‚ã®ã¿å†è©¦è¡Œï¼‰"
          if ! az role assignment create \
            --assignee-object-id "$PRINCIPAL_ID" \
            --assignee-principal-type ServicePrincipal \
            --role "Storage Blob Data Contributor" \
            --scope "$STORAGE_ID"; then
              echo "âš ï¸ Storage ãƒ­ãƒ¼ãƒ«ä»˜ä¸Žã«å¤±æ•—ã—ã¾ã—ãŸã€‚${ROLE_RETRY_WAIT_SECONDS} ç§’å¾…ã£ã¦å†å®Ÿè¡Œã—ã¾ã™" >&2
              sleep $ROLE_RETRY_WAIT_SECONDS
              az role assignment create \
                --assignee-object-id "$PRINCIPAL_ID" \
                --assignee-principal-type ServicePrincipal \
                --role "Storage Blob Data Contributor" \
                --scope "$STORAGE_ID" || {
                  echo "âŒ Storage ãƒ­ãƒ¼ãƒ«ä»˜ä¸ŽãŒç¹°ã‚Šè¿”ã—å¤±æ•—ã—ã¾ã—ãŸ" >&2
                  exit 1
                }
          else
            echo "âœ“ Storage ãƒ­ãƒ¼ãƒ«ä»˜ä¸ŽæˆåŠŸ"
          fi
          echo "âš ï¸ ã€è­¦å‘Šã€‘Managed Identity ã« Subscription ãƒ¬ãƒ™ãƒ«ã® Contributor ãŒä»˜ä¸Žã•ã‚Œã¾ã—ãŸ"
          echo "æœ¬ç•ªç’°å¢ƒã§ã¯æœ€å°æ¨©é™ã®åŽŸå‰‡ã«å¾“ã„ã€å¿…è¦æœ€å°é™ã®ãƒ­ãƒ¼ãƒ«ã®ã¿ã‚’ä»˜ä¸Žã—ã¦ãã ã•ã„"

          echo ""
          echo "ðŸ“‹ Managed Identity ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¾ã™"
          az role assignment list \
            --assignee "$PRINCIPAL_ID" \
            --include-inherited \
            --all \
            -o table || echo "âš ï¸ ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰"

  post-deploy-summary:
    runs-on: ubuntu-latest
    needs: [prepare-container-app, revision-deploy]
    if: ${{ needs.revision-deploy.result == 'success' }}
    env:
      IMAGE_FULL: ${{ needs.prepare-container-app.outputs.image_full }}
      ACA_ENVIRONMENT_NAME: ${{ needs.prepare-container-app.outputs.aca_environment_name }}
      DB_ENDPOINT_RESOLVED: ${{ needs.prepare-container-app.outputs.db_endpoint }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒžãƒªã‚’å‡ºåŠ›
        run: |
          FQDN=$(az containerapp show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          PROVISIONING_STATE=$(az containerapp show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "properties.provisioningState" -o tsv)
          RUNNING_STATUS=$(az containerapp show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "properties.runningStatus" -o tsv)
          echo "## ðŸŽ¯ ç®¡ç†ã‚¢ãƒ—ãƒª Container Apps ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Container App å**: \`$CONTAINER_APP_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`$ACA_ENVIRONMENT_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¤ãƒ¡ãƒ¼ã‚¸**: \`$IMAGE_FULL\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Provisioning State**: \`$PROVISIONING_STATE\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Running Status**: \`$RUNNING_STATUS\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **FQDN**: \`$FQDN\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¢ã‚¯ã‚»ã‚¹URL**: https://$FQDN" >> $GITHUB_STEP_SUMMARY
          FQDN_PART1="${FQDN%%.*}"
          FQDN_REST="${FQDN#*.}"
          echo "- **FQDN**: \`$FQDN_PART1\`.\`$FQDN_REST\`" >> $GITHUB_STEP_SUMMARY
          echo "- **èªè¨¼**: Basic èªè¨¼ (ID/Password å¿…è¦)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ ç’°å¢ƒå¤‰æ•°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **DB_ENDPOINT**: \`$DB_ENDPOINT_RESOLVED\`" >> $GITHUB_STEP_SUMMARY
          echo "- **BACKUP_CONTAINER**: \`$BACKUP_CONTAINER\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ADMIN_USERNAME**: secretref" >> $GITHUB_STEP_SUMMARY
          echo "- **ADMIN_PASSWORD**: secretref" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY

      - name: FQDN ã‚’è¡¨ç¤º
        run: |
          az containerapp show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "properties.configuration.ingress.fqdn"
