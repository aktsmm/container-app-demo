name: infra-deploy

on:
    workflow_dispatch:
    push:
        paths:
            - "infra/**"
            - ".github/workflows/infra-deploy.yml"

permissions:
    contents: read

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  LOCATION: ${{ vars.LOCATION }}
  PARAM_FILE: infra/parameters/main-dev.parameters.json
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  STORAGE_ACCOUNT_PREFIX: ${{ vars.STORAGE_ACCOUNT_PREFIX }}

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Azure login (Service Principal)
              uses: azure/login@v2
              with:
                  client-id: ${{ vars.AZURE_CLIENT_ID }}
                  tenant-id: ${{ vars.AZURE_TENANT_ID }}
                  client-secret: ${{ vars.AZURE_CLIENT_SECRET }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: ユニーク名を決定
              run: |
                  set -euo pipefail
                  if [ -z "$ACR_NAME_PREFIX" ] || [ -z "$STORAGE_ACCOUNT_PREFIX" ]; then
                    echo "Prefix 変数が未設定です" >&2
                    exit 1
                  fi
                  generate_suffix() {
                    local raw num
                    raw=$(od -An -N2 -tu2 /dev/urandom | tr -d ' \n')
                    num=$(( raw % 9000 + 1000 ))
                    printf '%04d' "$num"
                  }
                  ACR_NAME=$(az acr list \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" \
                    -o tsv)
                  if [ -z "$ACR_NAME" ]; then
                    while true; do
                      SUFFIX=$(generate_suffix)
                      CANDIDATE="${ACR_NAME_PREFIX}${SUFFIX}"
                      CANDIDATE=$(echo "$CANDIDATE" | tr '[:upper:]' '[:lower:]')
                      AVAILABLE=$(az acr check-name --name "$CANDIDATE" --query nameAvailable -o tsv)
                      if [ "$AVAILABLE" = "true" ]; then
                        ACR_NAME="$CANDIDATE"
                        break
                      fi
                    done
                  fi
                  STORAGE_NAME=$(az storage account list \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --query "[?starts_with(name, '${STORAGE_ACCOUNT_PREFIX}')].name | [0]" \
                    -o tsv)
                  if [ -z "$STORAGE_NAME" ]; then
                    while true; do
                      SUFFIX=$(generate_suffix)
                      CANDIDATE="${STORAGE_ACCOUNT_PREFIX}${SUFFIX}"
                      CANDIDATE=$(echo "$CANDIDATE" | tr '[:upper:]' '[:lower:]')
                      AVAILABLE=$(az storage account check-name --name "$CANDIDATE" --query nameAvailable -o tsv)
                      if [ "$AVAILABLE" = "true" ]; then
                        STORAGE_NAME="$CANDIDATE"
                        break
                      fi
                    done
                  fi
                  echo "ACR_NAME=$ACR_NAME" >> "$GITHUB_ENV"
                  echo "ACR_LOGIN_SERVER=${ACR_NAME}.azurecr.io" >> "$GITHUB_ENV"
                  echo "STORAGE_ACCOUNT_NAME=$STORAGE_NAME" >> "$GITHUB_ENV"

            - name: Ensure resource group exists
              run: |
                  az group create \
                    --name "$RESOURCE_GROUP_NAME" \
                    --location "$LOCATION"

            - name: Bicep Validate
              run: |
                  az deployment group validate \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --name "validate-$(date +%s)" \
                    --template-file infra/main.bicep \
                    --parameters "@${{ env.PARAM_FILE }}" \
                    --parameters storageAccountName="$STORAGE_ACCOUNT_NAME" acrName="$ACR_NAME"

            - name: Bicep What-If
              run: |
                  az deployment group what-if \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --name "whatif-$(date +%s)" \
                    --template-file infra/main.bicep \
                    --parameters "@${{ env.PARAM_FILE }}" \
                    --parameters storageAccountName="$STORAGE_ACCOUNT_NAME" acrName="$ACR_NAME"

            - name: Bicep Deploy
              run: |
                  az deployment group create \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --name "deploy-$(date +%s)" \
                    --template-file infra/main.bicep \
                    --parameters "@${{ env.PARAM_FILE }}" \
                    --parameters storageAccountName="$STORAGE_ACCOUNT_NAME" acrName="$ACR_NAME" \
                    --only-show-errors

            - name: Azure logout
              if: always()
              run: az logout
