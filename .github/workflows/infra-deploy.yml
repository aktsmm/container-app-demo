name: infra-deploy

on:
    workflow_dispatch:
    push:
        paths:
            - "infra/**"
            - ".github/workflows/infra-deploy.yml"

permissions:
    contents: read

env:
    RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
    LOCATION: ${{ vars.LOCATION }}
    PARAM_FILE: infra/parameters/main-dev.parameters.json
    ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
    STORAGE_ACCOUNT_PREFIX: ${{ vars.STORAGE_ACCOUNT_PREFIX }}
    VM_ADMIN_USERNAME: ${{ vars.VM_ADMIN_USERNAME }}
    VM_ADMIN_PASSWORD: ${{ vars.VM_ADMIN_PASSWORD }}
    MYSQL_ROOT_PASSWORD: ${{ vars.MYSQL_ROOT_PASSWORD }}
    DB_APP_USERNAME: ${{ vars.DB_APP_USERNAME }}
    DB_APP_PASSWORD: ${{ vars.DB_APP_PASSWORD }}

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Azure login (Service Principal)
              uses: azure/login@v2
              with:
                  creds: >-
                      {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

            - name: ユニーク名を決定
              run: |
                  set -euo pipefail
                  if [ -z "$ACR_NAME_PREFIX" ] || [ -z "$STORAGE_ACCOUNT_PREFIX" ]; then
                    echo "Prefix 変数が未設定です" >&2
                    exit 1
                  fi
                  # 既存リソースを参照する前にRGの有無を判定し、初回デプロイでの404を防ぐ
                  RG_EXISTS=$(az group exists --name "$RESOURCE_GROUP_NAME" || echo false)
                  if [ "$RG_EXISTS" != "true" ]; then
                    echo "Resource group $RESOURCE_GROUP_NAME は未作成のため新規作成として処理します"
                    RG_EXISTS=false
                  fi
                  generate_suffix() {
                    local raw num
                    raw=$(od -An -N2 -tu2 /dev/urandom | tr -d ' \n')
                    num=$(( raw % 9000 + 1000 ))
                    printf '%04d' "$num"
                  }
                  if [ "$RG_EXISTS" = "true" ]; then
                    ACR_NAME=$(az acr list \
                      --resource-group "$RESOURCE_GROUP_NAME" \
                      --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" \
                      -o tsv)
                  else
                    ACR_NAME=""
                  fi
                  if [ -z "$ACR_NAME" ]; then
                    while true; do
                      SUFFIX=$(generate_suffix)
                      CANDIDATE="${ACR_NAME_PREFIX}${SUFFIX}"
                      CANDIDATE=$(echo "$CANDIDATE" | tr '[:upper:]' '[:lower:]')
                      AVAILABLE=$(az acr check-name --name "$CANDIDATE" --query nameAvailable -o tsv)
                      if [ "$AVAILABLE" = "true" ]; then
                        ACR_NAME="$CANDIDATE"
                        break
                      fi
                    done
                  fi
                  if [ "$RG_EXISTS" = "true" ]; then
                    STORAGE_NAME=$(az storage account list \
                      --resource-group "$RESOURCE_GROUP_NAME" \
                      --query "[?starts_with(name, '${STORAGE_ACCOUNT_PREFIX}')].name | [0]" \
                      -o tsv)
                  else
                    STORAGE_NAME=""
                  fi
                  if [ -z "$STORAGE_NAME" ]; then
                    while true; do
                      SUFFIX=$(generate_suffix)
                      CANDIDATE="${STORAGE_ACCOUNT_PREFIX}${SUFFIX}"
                      CANDIDATE=$(echo "$CANDIDATE" | tr '[:upper:]' '[:lower:]')
                      AVAILABLE=$(az storage account check-name --name "$CANDIDATE" --query nameAvailable -o tsv)
                      if [ "$AVAILABLE" = "true" ]; then
                        STORAGE_NAME="$CANDIDATE"
                        break
                      fi
                    done
                  fi
                  echo "ACR_NAME=$ACR_NAME" >> "$GITHUB_ENV"
                  echo "ACR_LOGIN_SERVER=${ACR_NAME}.azurecr.io" >> "$GITHUB_ENV"
                  echo "STORAGE_ACCOUNT_NAME=$STORAGE_NAME" >> "$GITHUB_ENV"

            - name: AKS 用一時 SSH 鍵生成 (秘密鍵はCI内のみ利用し保持しない)
              run: |
                set -euo pipefail
                ssh-keygen -t rsa -b 4096 -f aks_temp_key -N '' -C "aks-demo-dev" >/dev/null 2>&1
                PUB_KEY=$(cat aks_temp_key.pub | tr -d '\n')
                echo "AKS_SSH_PUBLIC_KEY=$PUB_KEY" >> "$GITHUB_ENV"
                rm -f aks_temp_key  # 秘密鍵は不要なので削除
              shell: bash

            - name: 入力値を検証
              run: |
                  set -euo pipefail
                  if [ -z "$VM_ADMIN_USERNAME" ] || [ -z "$VM_ADMIN_PASSWORD" ]; then
                    echo "VM の認証情報が未設定です。GitHub Actions の Variables/Secrets を確認してください" >&2
                    exit 1
                  fi
                  if [ -z "$MYSQL_ROOT_PASSWORD" ] || [ -z "$DB_APP_USERNAME" ] || [ -z "$DB_APP_PASSWORD" ]; then
                    echo "MySQL の認証情報が未設定です。GitHub Actions で MYSQL_ROOT_PASSWORD / DB_APP_USERNAME / DB_APP_PASSWORD を定義してください" >&2
                    exit 1
                  fi

            - name: Ensure resource group exists
              run: |
                  az group create \
                    --name "$RESOURCE_GROUP_NAME" \
                    --location "$LOCATION"

            - name: Bicep Validate
              run: |
                  az deployment group validate \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --name "validate-$(date +%s)" \
                    --template-file infra/main.bicep \
                    --parameters "@${{ env.PARAM_FILE }}" \
                    --parameters storageAccountName="$STORAGE_ACCOUNT_NAME" acrName="$ACR_NAME" \
                    --parameters vmAdminUsername="$VM_ADMIN_USERNAME" vmAdminPassword="$VM_ADMIN_PASSWORD" \
                    --parameters mysqlRootPassword="$MYSQL_ROOT_PASSWORD" mysqlAppUsername="$DB_APP_USERNAME" mysqlAppPassword="$DB_APP_PASSWORD" \
                    --parameters aksSshPublicKey="$AKS_SSH_PUBLIC_KEY"

            - name: Bicep What-If
              run: |
                  az deployment group what-if \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --name "whatif-$(date +%s)" \
                    --template-file infra/main.bicep \
                    --parameters "@${{ env.PARAM_FILE }}" \
                    --parameters storageAccountName="$STORAGE_ACCOUNT_NAME" acrName="$ACR_NAME" \
                    --parameters vmAdminUsername="$VM_ADMIN_USERNAME" vmAdminPassword="$VM_ADMIN_PASSWORD" \
                    --parameters mysqlRootPassword="$MYSQL_ROOT_PASSWORD" mysqlAppUsername="$DB_APP_USERNAME" mysqlAppPassword="$DB_APP_PASSWORD" \
                    --parameters aksSshPublicKey="$AKS_SSH_PUBLIC_KEY"

            - name: Bicep Deploy
              run: |
                  az deployment group create \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --name "deploy-$(date +%s)" \
                    --template-file infra/main.bicep \
                    --parameters "@${{ env.PARAM_FILE }}" \
                    --parameters storageAccountName="$STORAGE_ACCOUNT_NAME" acrName="$ACR_NAME" \
                    --parameters vmAdminUsername="$VM_ADMIN_USERNAME" vmAdminPassword="$VM_ADMIN_PASSWORD" \
                    --parameters mysqlRootPassword="$MYSQL_ROOT_PASSWORD" mysqlAppUsername="$DB_APP_USERNAME" mysqlAppPassword="$DB_APP_PASSWORD" \
                    --parameters aksSshPublicKey="$AKS_SSH_PUBLIC_KEY" \
                    --only-show-errors

            - name: Azure logout
              if: always()
              run: az logout
