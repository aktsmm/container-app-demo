name: infra-deploy

on:
    workflow_dispatch:
    push:
        paths:
            - "infra/**"
            - ".github/workflows/infra-deploy.yml"

permissions:
    contents: read

env:
    RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
    LOCATION: ${{ vars.LOCATION }}
    PARAM_FILE: infra/parameters/main-dev.parameters.json

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Azure login (Service Principal)
              uses: azure/login@v2
              with:
                  client-id: ${{ vars.AZURE_CLIENT_ID }}
                  tenant-id: ${{ vars.AZURE_TENANT_ID }}
                  client-secret: ${{ vars.AZURE_CLIENT_SECRET }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Ensure resource group exists
              run: |
                  az group create \
                    --name "$RESOURCE_GROUP_NAME" \
                    --location "$LOCATION"

            - name: Bicep Validate
              run: |
                  az deployment group validate \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --name "validate-$(date +%s)" \
                    --template-file infra/main.bicep \
                    --parameters "@${{ env.PARAM_FILE }}"

            - name: Bicep What-If
              run: |
                  az deployment group what-if \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --name "whatif-$(date +%s)" \
                    --template-file infra/main.bicep \
                    --parameters "@${{ env.PARAM_FILE }}"

            - name: Bicep Deploy
              run: |
                  az deployment group create \
                    --resource-group "$RESOURCE_GROUP_NAME" \
                    --name "deploy-$(date +%s)" \
                    --template-file infra/main.bicep \
                    --parameters "@${{ env.PARAM_FILE }}" \
                    --only-show-errors

            - name: Azure logout
              if: always()
              run: az logout
