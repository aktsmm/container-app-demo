name: üîÑ MySQL Backup Upload (Scheduled)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  VM_NAME: ${{ vars.VM_NAME }}
  STORAGE_ACCOUNT_PREFIX: ${{ vars.STORAGE_ACCOUNT_PREFIX }}
  BACKUP_CONTAINER_NAME: ${{ vars.BACKUP_CONTAINER_NAME }}

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Azure „Å´ OIDC „Åß„É≠„Ç∞„Ç§„É≥
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: „Çπ„Éà„É¨„Éº„Ç∏„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíËß£Ê±∫
        run: |
          set -euo pipefail
          if [ -z "$STORAGE_ACCOUNT_PREFIX" ] || [ -z "$RESOURCE_GROUP_NAME" ]; then
            echo "„Çπ„Éà„É¨„Éº„Ç∏„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÊ±∫ÂÆö„Åô„Çã„Åü„ÇÅ„ÅÆÂ§âÊï∞„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô" >&2
            exit 1
          fi
          STORAGE_ACCOUNT_NAME=$(az storage account list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[?starts_with(name, '${STORAGE_ACCOUNT_PREFIX}')].name | [0]" \
            -o tsv)
          if [ -z "$STORAGE_ACCOUNT_NAME" ]; then
            echo "ÊåáÂÆö„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÅÆ„Çπ„Éà„É¨„Éº„Ç∏„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì„ÄÇinfra-deploy „ÇíÂÖà„Å´ÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ" >&2
            exit 1
          fi
          echo "STORAGE_ACCOUNT_NAME=$STORAGE_ACCOUNT_NAME" >> "$GITHUB_ENV"

      - name: Storage Áî® SAS „ÇíÁô∫Ë°å
        id: sas
        run: |
          EXPIRY=$(date -u -d '+90 minutes' +%Y-%m-%dT%H:%MZ)
          SAS=$(az storage account generate-sas \
            --permissions acdlpu \
            --account-name "$STORAGE_ACCOUNT_NAME" \
            --services b \
            --resource-types co \
            --expiry "$EXPIRY" \
            -o tsv)
          echo "SAS_TOKEN=$SAS" >> "$GITHUB_ENV"

      - name: VM ‰∏ä„Åß„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å„Åó„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        env:
          MYSQL_ROOT_PASSWORD: ${{ vars.MYSQL_ROOT_PASSWORD }}
        run: |
          SCRIPT=$(cat <<'EOF'
          set -euo pipefail
          STORAGE_ACCOUNT_NAME="$1"
          BACKUP_CONTAINER_NAME="$2"
          SAS_TOKEN="$3"
          MYSQL_ROOT_PASSWORD="$4"
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          BACKUP_DIR=/tmp/mysql-backups
          mkdir -p "$BACKUP_DIR"
          BACKUP_FILE="$BACKUP_DIR/backup-$TIMESTAMP.sql"
          mysqldump --all-databases --single-transaction --quick --lock-tables=false -u root -p"$MYSQL_ROOT_PASSWORD" > "$BACKUP_FILE"
          if ! command -v azcopy >/dev/null 2>&1; then
            TMPDIR=$(mktemp -d)
            curl -sSL https://aka.ms/downloadazcopy-v10-linux | tar -xz -C "$TMPDIR"
            AZCOPY_PATH=$(find "$TMPDIR" -name azcopy -type f | head -n 1)
            sudo install -m 755 "$AZCOPY_PATH" /usr/local/bin/azcopy
          fi
          DEST_URL="https://${STORAGE_ACCOUNT_NAME}.blob.core.windows.net/${BACKUP_CONTAINER_NAME}/backup-${TIMESTAMP}.sql?${SAS_TOKEN}"
          azcopy copy "$BACKUP_FILE" "$DEST_URL" --from-to=LocalBlob --overwrite ifSourceNewer --log-level WARNING
          logger "mysql-backup-upload success $TIMESTAMP"
          EOF
          )

          az vm run-command invoke \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$VM_NAME" \
            --command-id RunShellScript \
            --scripts "$SCRIPT" \
            --parameters "$STORAGE_ACCOUNT_NAME" "$BACKUP_CONTAINER_NAME" "$SAS_TOKEN" "$MYSQL_ROOT_PASSWORD"
